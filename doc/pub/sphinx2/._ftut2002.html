<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>PDE solver design and coding practices</title>
    
    <link rel="stylesheet" href="_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap-sphinx.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.6',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="_static/bootstrap-sphinx.js"></script>

        <script src="http://sagecell.sagemath.org/static/jquery.min.js"></script>
        <script src="http://sagecell.sagemath.org/static/embedded_sagecell.js"></script>

        <script>sagecell.makeSagecell({inputLocation: ".sage"});</script>

        <style type="text/css">
                .sagecell .CodeMirror-scroll {
                        overflow-y: hidden;
                        overflow-x: auto;
                }
                .sagecell .CodeMirror {
                        height: auto;
                }
        </style>

    
    <link rel="top" title="The FEniCS Tutorial Volume II" href="index.html" />
    <link rel="next" title="Implementing solvers for nonlinear PDEs" href="._ftut2003.html" />
    <link rel="prev" title="Developing a more advanced heat equation solver" href="._ftut2001.html" />

  <meta charset='utf-8'>
  <meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
  <meta name="apple-mobile-web-app-capable" content="yes">

  <!-- Default Bootstrap-->
  <link rel="stylesheet" href="_static/css/bootstrap.min.css"/>
  <link rel="shortcut icon" href="_static/fenics.ico" />
  <!-- Template styles CSS-->
  <link rel="stylesheet" href="_static/css/main.css"/>
  <link rel="stylesheet" href="_static/css/custom.css"/>
  <link rel="stylesheet" href="_static/css/font-awesome.min.css"/>
  <link rel="stylesheet" href="_static/css/animate.min.css"/>
  <link rel="stylesheet" href="_static/css/responsive.css"/>

  <!-- Template styles JS-->
  <script src="_static/slides.min.jquery.js"></script>
  <script type="text/javascript" src="_static/js/jquery-1.11.0.min.js"></script>
  <script type="text/javascript" src="_static/js/jquery-fix.js"></script>
  <script type="text/javascript" src="_static/js/bootstrap.js"></script>
  <script type="text/javascript" src="_static/js/bootstrap.min.js"></script>
  <script type="text/javascript" src="_static/js/wow.min.js"></script>
  <script type="text/javascript" src="_static/js/main.js"></script>
  <script type="text/javascript" src="_static/js/jquery.bcSwipe.js"></script>
  <script>
    $(document).ready(function() {
         $("#mycarousel").swiperight(function() {
            $(this).carousel('prev');
            });
         $("#mycarousel").swipeleft(function() {
            $(this).carousel('next');
       });
    });
  </script>

  
       <style type="text/css">
         div.admonition {
           background-color: whiteSmoke;
           border: 1px solid #bababa;
         }
       </style>
      </head>
    
  <body role="document">
<header id="header">
      <div class="navbar navbar-inverse" role="banner">
          <div class="container">
              <div class="navbar-header">
                  <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#headernavbar">
                      <span class="sr-only">Toggle navigation</span>
                      <span class="icon-bar"></span>
                      <span class="icon-bar"></span>
                      <span class="icon-bar"></span>
                  </button>

                  <a class="navbar-brand" href="http://fenicsproject.org/index.html">
                      <h1><img src="_static/fenics_banner.png" alt="FEniCS Project Logo" class="img-responsive center-block banner-image"></h1>
                  </a>

              </div>
              <div class="collapse navbar-collapse" id="headernavbar">
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="._ftut2001.html" title="Previous page">Prev</a></li>
                    <li><a href="._ftut2003.html" title="Next page">Next</a></li>
                    <li class="page_item"><a href="http://fenicsproject.org/index.html">Home</a></li>
                    <li class="page_item"><a href="http://fenicsproject.org/about/" title="Find out more about the FEniCS project">About</a></li>
                    <li class="page_item"><a href="http://fenicsproject.org/download/" title="Obtain the FEniCS project">Download</a></li>
                    <li class="page_item"><a href="http://fenicsproject.org/documentation/" title="Learn how to use the FEniCS project">Documentation</a></li>
                    <li class="page_item"><a href="http://fenicsproject.org/contributing/" title="Learn how to contribute to the FEniCS project">Contributing</a></li>
                    <li class="page_item"><a href="http://fenicsproject.org/citing/" title="Learn how to cite the FEniCS project">Citing</a></li>
                    <li class="page_item"><a href="http://fenicsproject.org/support/" title="Where to go for more help">Support</a></li>
                  </ul>
              </div>
          </div>
      </div>
  </header>

<div class="container">
  <div class="row">
    <div class="col-md-12">
      
  <div class="section" id="pde-solver-design-and-coding-practices">
<span id="ch-classes"></span><h1>PDE solver design and coding practices<a class="headerlink" href="#pde-solver-design-and-coding-practices" title="Permalink to this headline">¶</a></h1>
<p>In the very beginning of this tutorial <a class="reference internal" href="._ftut2008.html#ref1" id="id1">[Ref1]</a> we focused on how
to quickly put together solvers for a number of different PDEs. FEniCS
makes it simple and straightforward to write the commands needed to
set up a variational problem, define domains and boundary
conditions. Then we wrapped such flat programs in functions for
increased flexibility and easy testing.
However, for a real application you will likely want to be
able to reuse the code you write for a particular PDE to solve
multiple different problems with different domains, boundary
conditions and other parameters. In this chapter, we look at how to
structure FEniCS Python code to create flexible, reusable, and
efficient PDE solvers. The key concept is to use Python classes and
develop effective an Application Programming Interface (API)
in terms of methods and their arguments.</p>
<div class="section" id="refactoring-a-poisson-solver-in-terms-of-classes">
<span id="ch-poisson0-refactor-class"></span><h2>Refactoring a Poisson solver in terms of classes<a class="headerlink" href="#refactoring-a-poisson-solver-in-terms-of-classes" title="Permalink to this headline">¶</a></h2>
<p>A FEniCS solver for a PDE can be implemented in a general way, but the
problem-dependent data, like boundary conditions, must be specified in
each case by the user. For example, the implementation in in <a class="reference internal" href="._ftut2008.html#ref1" id="id2">[Ref1]</a>
requires the user to supply a
<code class="docutils literal"><span class="pre">boundary_conditions</span></code> dictionary with specifications of the boundary
condition on each of the four sides of the unit square. If we, e.g.,
want two Dirichlet conditions at one side, this is not possible
without modifying the solver function. What do to with a general
mesh is an open question. To avoid changing the code in what is
meant to be a general PDE solver for a wide class of problems, we need
a different software design.</p>
<p>Such a different design is to introduce a problem class and
methods, supplied by the user from case to case, where boundary
conditions and other input data are defined. Such a design is used in
a lot of more advanced FEniCS application codes, and it is time to
exemplify it here.  As a counterpart to the solver function, we
introduce a solver class, but all the arguments for various input data
are instead method calls to an instance of a <em>problem class</em>. This
puts a somewhat greater burden on the programmer, but it allows for
more flexibility, and the code for, e.g., boundary conditions can be
more tailored to the problem at hand than the code we introduced in
the <code class="docutils literal"><span class="pre">solver_bc</span></code> function in the section <span class="xref std std-ref">ch:poisson0:multi:bc</span>.</p>
<div class="section" id="the-solver-class-1">
<span id="ch-poisson0-refactor-class-solver"></span><h3>The solver class<a class="headerlink" href="#the-solver-class-1" title="Permalink to this headline">¶</a></h3>
<p>The solver class will need problem information and for this purpose
call up the methods in a problem class. For example, the solver
gets the <span class="math">\(f\)</span> and <span class="math">\(p\)</span> functions in the PDE problem by calling
<code class="docutils literal"><span class="pre">problem.f_rhs()</span></code> and <code class="docutils literal"><span class="pre">problem.p_coeff()</span></code>. The mesh object and the
polynomial degree of the elements are supposed to be returned from
<code class="docutils literal"><span class="pre">problem.mesh_degree()</span></code>. Furthermore, the problem class defines the
boundary conditions in the problem as lists of minimal information
from which the solver can build proper data structures.</p>
<p>The solver class is a wrapping of the previous <code class="docutils literal"><span class="pre">solver_bc</span></code> and <code class="docutils literal"><span class="pre">flux</span></code>
functions as methods in a class, but some of the code for handling
boundary conditions in <code class="docutils literal"><span class="pre">solver_bc</span></code> is now delegated to the user in
the problem class.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">fenics</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="k">class</span> <span class="nc">PoissonSolver</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">problem</span> <span class="o">=</span> <span class="n">problem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>

    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">linear_solver</span><span class="o">=</span><span class="s1">&#39;direct&#39;</span><span class="p">):</span>
        <span class="n">Dirichlet_cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">Dirichlet_conditions</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Dirichlet_cond</span><span class="p">,</span> <span class="p">(</span><span class="n">Expression</span><span class="p">)):</span>
            <span class="c1"># Just one Expression for Dirichlet conditions on</span>
            <span class="c1"># the entire boundary</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bcs</span> <span class="o">=</span> <span class="p">[</span><span class="n">DirichletBC</span><span class="p">(</span>
                <span class="n">V</span><span class="p">,</span> <span class="n">Dirichlet_cond</span><span class="p">,</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">on_boundary</span><span class="p">:</span> <span class="n">on_boundary</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Boundary SubDomain markers</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bcs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">DirichletBC</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">boundaries</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">value</span><span class="p">,</span> <span class="n">boundaries</span><span class="p">,</span> <span class="n">index</span>
                <span class="ow">in</span> <span class="n">Dirichlet_cond</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="c1"># Print the Dirichlet conditions</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;No of Dirichlet conditions:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bcs</span><span class="p">))</span>
            <span class="n">coor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">coordinates</span><span class="p">()</span>
            <span class="n">d2v</span> <span class="o">=</span> <span class="n">dof_to_vertex_map</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">bc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bcs</span><span class="p">:</span>
                <span class="n">bc_dict</span> <span class="o">=</span> <span class="n">bc</span><span class="o">.</span><span class="n">get_boundary_values</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">dof</span> <span class="ow">in</span> <span class="n">bc_dict</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;dof </span><span class="si">%2d</span><span class="s1">: u=</span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dof</span><span class="p">,</span> <span class="n">bc_dict</span><span class="p">[</span><span class="n">dof</span><span class="p">]))</span>
                    <span class="k">if</span> <span class="n">V</span><span class="o">.</span><span class="n">ufl_element</span><span class="p">()</span><span class="o">.</span><span class="n">degree</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;   at point </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                              <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">coor</span><span class="p">[</span><span class="n">d2v</span><span class="p">[</span><span class="n">dof</span><span class="p">]]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))))</span>
        <span class="c1"># Compute solution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">linear_solver</span> <span class="o">==</span> <span class="s1">&#39;Krylov&#39;</span><span class="p">:</span>
            <span class="n">solver_parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;linear_solver&#39;</span><span class="p">:</span> <span class="s1">&#39;gmres&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;preconditioner&#39;</span><span class="p">:</span> <span class="s1">&#39;ilu&#39;</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">solver_parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;linear_solver&#39;</span><span class="p">:</span> <span class="s1">&#39;lu&#39;</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">define_variational_problem</span><span class="p">()</span>
        <span class="n">solve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bcs</span><span class="p">,</span>
              <span class="n">solver_parameters</span><span class="o">=</span><span class="n">solver_parameters</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span>

    <span class="k">def</span> <span class="nf">define_variational_problem</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">degree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">mesh_degree</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="o">=</span> <span class="n">V</span> <span class="o">=</span> <span class="n">FunctionSpace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="n">degree</span><span class="p">)</span>

        <span class="n">u</span> <span class="o">=</span> <span class="n">TrialFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">TestFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">p_coeff</span><span class="p">()</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">f_rhs</span><span class="p">()</span>
        <span class="n">F</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">p</span><span class="o">*</span><span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">grad</span><span class="p">(</span><span class="n">v</span><span class="p">))</span><span class="o">*</span><span class="n">dx</span>
        <span class="n">F</span> <span class="o">-=</span> <span class="n">f</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="n">dx</span>
        <span class="n">F</span> <span class="o">-=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">g</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="n">ds_</span>
                  <span class="k">for</span> <span class="n">g</span><span class="p">,</span> <span class="n">ds_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">Neumann_conditions</span><span class="p">()])</span>
        <span class="n">F</span> <span class="o">+=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">r</span><span class="o">*</span><span class="p">(</span><span class="n">u</span><span class="o">-</span><span class="n">s</span><span class="p">)</span><span class="o">*</span><span class="n">ds_</span>
                  <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">ds_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">Robin_conditions</span><span class="p">()])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">lhs</span><span class="p">(</span><span class="n">F</span><span class="p">),</span> <span class="n">rhs</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="ow">and</span> <span class="n">V</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">:</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">assemble</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;A:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">A</span><span class="o">.</span><span class="n">array</span><span class="p">())</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">assemble</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;b:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">array</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">flux</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute and return flux -p*grad(u).&quot;&quot;&quot;</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">function_space</span><span class="p">()</span><span class="o">.</span><span class="n">mesh</span><span class="p">()</span>
        <span class="n">degree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">ufl_element</span><span class="p">()</span><span class="o">.</span><span class="n">degree</span><span class="p">()</span>
        <span class="n">V_g</span> <span class="o">=</span> <span class="n">VectorFunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="n">degree</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">p_coeff</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flux_u</span> <span class="o">=</span> <span class="n">project</span><span class="p">(</span><span class="o">-</span><span class="n">p</span><span class="o">*</span><span class="n">grad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">),</span> <span class="n">V_g</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flux_u</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;flux(u)&#39;</span><span class="p">,</span> <span class="s1">&#39;continuous flux field&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux_u</span>

<span class="k">class</span> <span class="nc">PoissonProblem</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Abstract base class for problems.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">linear_solver</span><span class="o">=</span><span class="s1">&#39;direct&#39;</span><span class="p">,</span>
              <span class="n">abs_tol</span><span class="o">=</span><span class="mf">1E-6</span><span class="p">,</span> <span class="n">rel_tol</span><span class="o">=</span><span class="mf">1E-5</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="n">PoissonSolver</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">prm</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;krylov_solver&#39;</span><span class="p">]</span> <span class="c1"># short form</span>
        <span class="n">prm</span><span class="p">[</span><span class="s1">&#39;absolute_tolerance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">abs_tol</span>
        <span class="n">prm</span><span class="p">[</span><span class="s1">&#39;relative_tolerance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rel_tol</span>
        <span class="n">prm</span><span class="p">[</span><span class="s1">&#39;maximum_iterations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_iter</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">linear_solver</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">solution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">u</span>

    <span class="k">def</span> <span class="nf">mesh_degree</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return mesh, degree.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Must implement mesh!&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">p_coeff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">f_rhs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">Dirichlet_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return list of (value,boundary_parts,index) triplets,</span>
<span class="sd">        or an Expression (if Dirichlet values only).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">Neumann_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return list of (g,ds(n)) pairs.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">Robin_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return list of (r,u,ds(n)) triplets.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span>
</pre></div>
</div>
<p>Note that this is a general Poisson problem solver that works in any number
of space dimensions and with any mesh and composition of boundary conditions!</p>
<div class="admonition-tip-be-careful-with-the-mesh-variable admonition">
<p class="first admonition-title">Tip: Be careful with the <code class="docutils literal"><span class="pre">mesh</span></code> variable</p>
<p class="last">In classes, one often stores the mesh in <code class="docutils literal"><span class="pre">self.mesh</span></code>. When you need
the mesh, it is easy to write just <code class="docutils literal"><span class="pre">mesh</span></code>, but this gives rise to
peculiar error messages, since <code class="docutils literal"><span class="pre">mesh</span></code> is a Python module imported
by <code class="docutils literal"><span class="pre">from</span> <span class="pre">fenics</span> <span class="pre">import</span> <span class="pre">*</span></code> and already available as a name in your file.
When encountering strange error messages in statements containing a
variable <code class="docutils literal"><span class="pre">mesh</span></code>, make sure you use <code class="docutils literal"><span class="pre">self.mesh</span></code>.</p>
</div>
</div>
<div class="section" id="a-problem-class">
<span id="ch-poisson0-refactor-class-problem0"></span><h3>A problem class<a class="headerlink" href="#a-problem-class" title="Permalink to this headline">¶</a></h3>
<p>Let us start with a relatively simple problem class for our favorite
test problem where we manufacture a solution <span class="math">\(u_{_\mathrm{D}}=1+x^2 + 2y^2\)</span> and
solve <span class="math">\(-\nabla^2 u = f\)</span> with <span class="math">\(f=6\)</span> and <span class="math">\(u=u_{_\mathrm{D}}\)</span> at the entire boundary.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TestProblemExact</span><span class="p">(</span><span class="n">PoissonProblem</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Nx</span><span class="p">,</span> <span class="n">Ny</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize mesh, boundary parts, and p.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">UnitSquareMesh</span><span class="p">(</span><span class="n">Nx</span><span class="p">,</span> <span class="n">Ny</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u_D</span> <span class="o">=</span> <span class="n">Expression</span><span class="p">(</span><span class="s1">&#39;1 + x[0]*x[0] + 2*x[1]*x[1]&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">mesh_degree</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">f_rhs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Constant</span><span class="p">(</span><span class="o">-</span><span class="mf">6.0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">Dirichlet_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">u_D</span>
</pre></div>
</div>
<p>We can then make a simple unit test for the problem and solver class:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_PoissonSolver</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Recover numerial solution to &quot;machine precision&quot;.&quot;&quot;&quot;</span>
    <span class="n">problem</span> <span class="o">=</span> <span class="n">TestProblemExact</span><span class="p">(</span><span class="n">Nx</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">Ny</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">problem</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">linear_solver</span><span class="o">=</span><span class="s1">&#39;direct&#39;</span><span class="p">)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">solution</span><span class="p">()</span>
    <span class="n">u_e</span> <span class="o">=</span> <span class="n">interpolate</span><span class="p">(</span><span class="n">problem</span><span class="o">.</span><span class="n">u_D</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">function_space</span><span class="p">())</span>
    <span class="n">max_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u_e</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">array</span><span class="p">()</span> <span class="o">-</span>
                       <span class="n">u</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">array</span><span class="p">())</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">tol</span> <span class="o">=</span> <span class="mf">1E-14</span>
    <span class="k">assert</span> <span class="n">max_error</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">,</span> <span class="s1">&#39;max error: </span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">max_error</span>
</pre></div>
</div>
</div>
<div class="section" id="a-more-complicated-problem-class">
<span id="ch-poisson0-refactor-class-problem1"></span><h3>A more complicated problem class<a class="headerlink" href="#a-more-complicated-problem-class" title="Permalink to this headline">¶</a></h3>
<p>Below is the specific problem class for solving a scaled 2D Poisson
problem.  We have a two-material domain where a rectangle
<span class="math">\([0.3,0.7]\times [0.3,0.7]\)</span> is embedded in the unit square and where
<span class="math">\(p\)</span> has a constant value inside the rectangle and another value
outside. On <span class="math">\(x=0\)</span> and <span class="math">\(x=1\)</span> we have homogeneous Neumann conditions,
and on <span class="math">\(y=0\)</span> and <span class="math">\(y=1\)</span> we have the Dirichlet conditions <span class="math">\(u=1\)</span> and
<span class="math">\(u=0\)</span>, respectively.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Problem1</span><span class="p">(</span><span class="n">PoissonProblem</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    -div(p*grad(u)=f on the unit square.</span>
<span class="sd">    General Dirichlet, Neumann, or Robin condition along each</span>
<span class="sd">    side. Can have multiple subdomains with p constant in</span>
<span class="sd">    each subdomain.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Nx</span><span class="p">,</span> <span class="n">Ny</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize mesh, boundary parts, and p.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">UnitSquareMesh</span><span class="p">(</span><span class="n">Nx</span><span class="p">,</span> <span class="n">Ny</span><span class="p">)</span>

        <span class="n">tol</span> <span class="o">=</span> <span class="mf">1E-14</span>

        <span class="k">class</span> <span class="nc">BoundaryX0</span><span class="p">(</span><span class="n">SubDomain</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">inside</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">on_boundary</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">on_boundary</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">tol</span>

        <span class="k">class</span> <span class="nc">BoundaryX1</span><span class="p">(</span><span class="n">SubDomain</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">inside</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">on_boundary</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">on_boundary</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span>

        <span class="k">class</span> <span class="nc">BoundaryY0</span><span class="p">(</span><span class="n">SubDomain</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">inside</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">on_boundary</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">on_boundary</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">tol</span>

        <span class="k">class</span> <span class="nc">BoundaryY1</span><span class="p">(</span><span class="n">SubDomain</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">inside</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">on_boundary</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">on_boundary</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span>

        <span class="c1"># Mark boundaries</span>
        <span class="c1">#self.boundary_parts = FacetFunction(&#39;size_t&#39;, mesh)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boundary_parts</span> <span class="o">=</span> <span class="n">FacetFunction</span><span class="p">(</span><span class="s1">&#39;uint&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boundary_parts</span><span class="o">.</span><span class="n">set_all</span><span class="p">(</span><span class="mi">9999</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bx0</span> <span class="o">=</span> <span class="n">BoundaryX0</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bx1</span> <span class="o">=</span> <span class="n">BoundaryX1</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">by0</span> <span class="o">=</span> <span class="n">BoundaryY0</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">by1</span> <span class="o">=</span> <span class="n">BoundaryY1</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bx0</span><span class="o">.</span><span class="n">mark</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_parts</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bx1</span><span class="o">.</span><span class="n">mark</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_parts</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">by0</span><span class="o">.</span><span class="n">mark</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_parts</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">by1</span><span class="o">.</span><span class="n">mark</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_parts</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="o">=</span>  <span class="n">Measure</span><span class="p">(</span>
            <span class="s1">&#39;ds&#39;</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
            <span class="n">subdomain_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_parts</span><span class="p">)</span>

        <span class="c1"># The domain is the unit square with an embedded rectangle</span>
        <span class="k">class</span> <span class="nc">Rectangle</span><span class="p">(</span><span class="n">SubDomain</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">inside</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">on_boundary</span><span class="p">):</span>
                <span class="k">return</span> <span class="mf">0.3</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">0.7</span> <span class="ow">and</span> <span class="mf">0.3</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">0.7</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">materials</span> <span class="o">=</span> <span class="n">CellFunction</span><span class="p">(</span><span class="s1">&#39;size_t&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">materials</span><span class="o">.</span><span class="n">set_all</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># &quot;the rest&quot;</span>
        <span class="n">subdomain</span> <span class="o">=</span> <span class="n">Rectangle</span><span class="p">()</span>
        <span class="n">subdomain</span><span class="o">.</span><span class="n">mark</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">materials</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">V0</span> <span class="o">=</span> <span class="n">FunctionSpace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="s1">&#39;DG&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V0</span><span class="p">)</span>
        <span class="n">help</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">materials</span><span class="o">.</span><span class="n">array</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">p_values</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1E-3</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">vector</span><span class="p">()[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">help</span><span class="p">,</span> <span class="n">p_values</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">mesh_degree</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="mi">2</span>

    <span class="k">def</span> <span class="nf">p_coeff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span>

    <span class="k">def</span> <span class="nf">f_rhs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">Dirichlet_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return list of (value,boundary) pairs.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[(</span><span class="mf">1.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_parts</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_parts</span><span class="p">,</span> <span class="mi">3</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">Neumann_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return list of g*ds(n) values.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">(</span><span class="mi">1</span><span class="p">))]</span>
</pre></div>
</div>
<p>A specific problem can be solved by</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">demo</span><span class="p">():</span>
    <span class="n">problem</span> <span class="o">=</span> <span class="n">PoissonProblem1</span><span class="p">(</span><span class="n">Nx</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">Ny</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">problem</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">linear_solver</span><span class="o">=</span><span class="s1">&#39;direct&#39;</span><span class="p">)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">solution</span><span class="p">()</span>
    <span class="n">u</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s1">&#39;potential&#39;</span><span class="p">)</span>  <span class="c1"># name &#39;u&#39; is used in plot</span>
    <span class="n">plot</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
    <span class="n">flux_u</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">flux</span><span class="p">()</span>
    <span class="n">plot</span><span class="p">(</span><span class="n">flux_u</span><span class="p">)</span>
    <span class="n">vtkfile</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="s1">&#39;poisson.pvd&#39;</span><span class="p">)</span>
    <span class="n">vtkfile</span> <span class="o">&lt;&lt;</span> <span class="n">u</span>
    <span class="n">interactive</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">TestProblemExact</span><span class="p">(</span><span class="n">PoissonProblem</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Nx</span><span class="p">,</span> <span class="n">Ny</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize mesh, boundary parts, and p.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">UnitSquareMesh</span><span class="p">(</span><span class="n">Nx</span><span class="p">,</span> <span class="n">Ny</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u_D</span> <span class="o">=</span> <span class="n">Expression</span><span class="p">(</span><span class="s1">&#39;1 + x[0]*x[0] + 2*x[1]*x[1]&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">mesh_degree</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">f_rhs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Constant</span><span class="p">(</span><span class="o">-</span><span class="mf">6.0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">Dirichlet_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">u_D</span>


<span class="k">def</span> <span class="nf">test_PoissonSolver</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Recover numerial solution to &quot;machine precision&quot;.&quot;&quot;&quot;</span>
    <span class="n">problem</span> <span class="o">=</span> <span class="n">TestProblemExact</span><span class="p">(</span><span class="n">Nx</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">Ny</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">problem</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">linear_solver</span><span class="o">=</span><span class="s1">&#39;direct&#39;</span><span class="p">)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">solution</span><span class="p">()</span>
    <span class="n">u_e</span> <span class="o">=</span> <span class="n">interpolate</span><span class="p">(</span><span class="n">problem</span><span class="o">.</span><span class="n">u_D</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">function_space</span><span class="p">())</span>
    <span class="n">max_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u_e</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">array</span><span class="p">()</span> <span class="o">-</span>
                       <span class="n">u</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">array</span><span class="p">())</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">tol</span> <span class="o">=</span> <span class="mf">1E-14</span>
    <span class="k">assert</span> <span class="n">max_error</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">,</span> <span class="s1">&#39;max error: </span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">max_error</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1">#demo()</span>
    <span class="n">test_PoissonSolver</span><span class="p">()</span>
</pre></div>
</div>
<p>The complete code is found in the file <code class="docutils literal"><span class="pre">ft10_poisson_class.py</span></code>.</p>
<div class="admonition-pros-and-cons-of-solver-problem-classes-vs-solver-function admonition">
<p class="first admonition-title">Pros and cons of solver/problem classes vs solver function</p>
<p class="last">What are the advantages of class <code class="docutils literal"><span class="pre">Solver</span></code> and <code class="docutils literal"><span class="pre">Problem</span></code> over the
function implementation in the section <span class="xref std std-ref">ch:poisson0:multi:bc</span>?
The primary advantage is that
the class version works for any mesh and any composition of
boundary conditions, while the solver function is tied to a mesh
over the unit square, only one type of boundary condition on a
each side, and a piecewise constant <span class="math">\(p\)</span> function. The programmer has
to supply more code in the class version, but gets greater flexibility.
The disadvantage of the class version is that it applies the class
concept so one needs experience with Python class programming.</p>
</div>
</div>
</div>
<div class="section" id="refactoring-a-heat-equation-solver">
<span id="ch-diffusion-refactor"></span><h2>Refactoring a heat equation solver<a class="headerlink" href="#refactoring-a-heat-equation-solver" title="Permalink to this headline">¶</a></h2>
<p>The flat program for the diffusion solver in <code class="docutils literal"><span class="pre">ft03_heat.py</span></code> and
<code class="docutils literal"><span class="pre">ft11_heat2.py</span></code> was refactored in <code class="docutils literal"><span class="pre">ft12_heat_func.py</span></code> in
terms of a <code class="docutils literal"><span class="pre">solver</span></code> function with the general code for solving the PDE
problem, a callback function for processing the solution at each time
step, and an application function defining the callback function and
calling the solver to solve a specific problem. However, for
time-dependent problems a solver function that gets all its input
through a set of arguments is less flexible than a solver class, which
can demand its input both through arguments and through functions (in
subclasses) provided by the user. The following text requires you to
be familiar with class programming in Python (tailored learning
material is Chapter 7, 9, and Appendix E in <a class="reference internal" href="._ftut2008.html#ref3" id="id3">[Ref3]</a>).</p>
<p>When we work with a PDE project, we often want to explore a range of
similar problems where the PDE model basically stays the same, but
coefficients in the PDE, boundary and initial conditions, as well as
domains change.  This means that some of our code related to solving
the PDE is always the same, while some of our code is strongly
dependent upon a particular application. To avoid copying code (which
is considered evil in computer programming), we need to collect the
common code for all problems of this type in one place and then create
an API (application programming interface) to the code that will be
different from application to application. To this end, we introduce a
<em>solver class</em> that applies FEniCS to solve the PDE. It requires
access to a <em>problem class</em> where all the application-specific details
are defined. This problem class defines an API that the solver class
applies for communication.</p>
<p>The solver class will usually have a function to set up data
structures for the variational formulation, a <code class="docutils literal"><span class="pre">step</span></code> function
to advance the solution one time step, and a <code class="docutils literal"><span class="pre">solve</span></code> function to run
the time loop. Every time the solver class needs problem-specific
information, it gets that information from the problem class, either in
terms of attributes (variables) in the problem class or in terms of method
(function) calls. The forthcoming examples are tied to the diffusion
equation, but should be sufficiently general to be reused for
most time-dependent FEniCS applications.</p>
<div class="section" id="problem-1-find-error-in-implementation">
<h3>Problem 1: Find error in implementation<a class="headerlink" href="#problem-1-find-error-in-implementation" title="Permalink to this headline">¶</a></h3>
<p>For those who are familiar with object-oriented programming, this is
seemingly a very simple exercise, but it makes sure you understand
class hierarchies and the associated program flow, so that you
are prepared to read the forthcoming text on solver and problem
classes.  The exercise also points out a very common bug in that
context. If you have problems with this exercise, we advise you to
read more about classes in Python (e.g., Chapter 7 and 9 in
<a class="reference internal" href="._ftut2008.html#ref3" id="id4">[Ref3]</a>), before you continue reading with the present book.</p>
<p>Somebody has made a class <code class="docutils literal"><span class="pre">Line</span></code> for straight lines <span class="math">\(y=ax+b\)</span>
where <span class="math">\(a\)</span> and <span class="math">\(b\)</span> are meant to be defined in subclasses by the
methods <code class="docutils literal"><span class="pre">constant</span></code> and <code class="docutils literal"><span class="pre">steepness_factor</span></code>, respectively.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Line</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">constant</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">steepness_factor</span><span class="p">()</span><span class="o">*</span><span class="n">x</span>

    <span class="k">def</span> <span class="nf">constant</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mf">1.0</span>

    <span class="k">def</span> <span class="nf">steepness_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mf">1.0</span>

<span class="k">class</span> <span class="nc">MyLine</span><span class="p">(</span><span class="n">Line</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">steepness_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="o">-</span><span class="mf">0.2</span>

<span class="n">line</span> <span class="o">=</span> <span class="n">MyLine</span><span class="p">()</span>
<span class="n">x</span> <span class="o">=</span> <span class="mi">2</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;x=</span><span class="si">%g</span><span class="s1">, y=</span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">line</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
</pre></div>
</div>
<p><strong>a)</strong>
Simulate the program above by hand. Make sure you understand the program
flow.</p>
<p><strong>Solution.</strong></p>
<p id="index-0">A nice tool to follow the program flow in simple programs is the
<a class="reference external" href="http://pythontutor.com/visualize.html#mode=edit">Online Python Tutor</a>.</p>
<iframe width="950" height="500" frameborder="0"
        src="http://pythontutor.com/iframe-embed.html#code=from+__future__+import+print_function%0A%0Aclass+Line%28object%29%3A%0A++++def+__call__%28self%2C+x%29%3A%0A++++++++return+self.constant%28%29+%2B+self.steepness_factor%28%29%2Ax%0A%0A++++def+constant%28self%29%3A%0A++++++++return+1.0%0A%0A++++def+steepness_factor%28self%29%3A%0A++++++++return+1.0%0A%0Aclass+MyLine%28Line%29%3A%0A++++def+steepness_factor%28self%29%3A%0A++++++++return+-0.2%0A%0Aline+%3D+MyLine%28%29%0Ax+%3D+2%0Aprint%28%27x%3D%25g%2C+y%3D%25g%27+%25+%28x%2C+line%28x%29%29%29&curInstr=0&py=2&cumulative=false">
</iframe><p>The Online Python Tutor is fine for simple test programs, but one cannot
use third-party Python modules. If that is required,
a debugger must be used. It is
visually less pleasant for following program flow, but will always
be applicable.</p>
<p>The program flow begins at the top of the file and goes down line by
line. First is the definition of the two classes. Then we have the
first line in the main program: <code class="docutils literal"><span class="pre">line</span> <span class="pre">=</span> <span class="pre">MyLine()</span></code>.  There is no
constructor in class <code class="docutils literal"><span class="pre">MyLine</span></code>, but it could be inherited from the
parent class <code class="docutils literal"><span class="pre">Line</span></code>. However, there is neither any constructor in
<code class="docutils literal"><span class="pre">Line</span></code>.  In such cases, Python equips the <code class="docutils literal"><span class="pre">Line</span></code> class with an empty
constructor as we had made an <code class="docutils literal"><span class="pre">__init__(self)</span></code> method with just <code class="docutils literal"><span class="pre">pass</span></code>
as body. This constructor is called by <code class="docutils literal"><span class="pre">MyLine()</span></code>.  It makes <code class="docutils literal"><span class="pre">line</span></code>
refer to an instance of class <code class="docutils literal"><span class="pre">MyLine</span></code>.</p>
<p>In the print statement, one needs to fill the string with
numbers, and after <code class="docutils literal"><span class="pre">x</span></code> is inserted, the call <code class="docutils literal"><span class="pre">line(x)</span></code> is performed.
Since <code class="docutils literal"><span class="pre">line</span></code> is an object of type <code class="docutils literal"><span class="pre">MyLine</span></code>, a function call
like <code class="docutils literal"><span class="pre">line(x)</span></code> is legal if the class has a special method
<code class="docutils literal"><span class="pre">__call__</span></code>. This is the case, since class <code class="docutils literal"><span class="pre">MyLine</span></code> inherits
<code class="docutils literal"><span class="pre">__call__</span></code> from the parent class <code class="docutils literal"><span class="pre">Line</span></code>.
The program flow moves to <code class="docutils literal"><span class="pre">Line.__call__</span></code> where we first call
<code class="docutils literal"><span class="pre">self.constant()</span></code>. Since the <code class="docutils literal"><span class="pre">self</span></code> object is of type <code class="docutils literal"><span class="pre">MyLine</span></code>,
this means we call <code class="docutils literal"><span class="pre">MyLine.constant</span></code>, but there is no <code class="docutils literal"><span class="pre">constant</span></code>
method in <code class="docutils literal"><span class="pre">MyLine</span></code>, meaning that it just inherits the <code class="docutils literal"><span class="pre">constant</span></code>
method from <code class="docutils literal"><span class="pre">Line</span></code>. Consequently, <code class="docutils literal"><span class="pre">Line.constant</span></code> is called and
returns 1.0. The next call is to <code class="docutils literal"><span class="pre">MyLine.steepness_factor</span></code>, and
this method is implemented in class <code class="docutils literal"><span class="pre">MyLine</span></code> and returns -0.2.
In <code class="docutils literal"><span class="pre">Line.__call__</span></code> we then evaluate <code class="docutils literal"><span class="pre">1.0</span> <span class="pre">+</span> <span class="pre">(-0.2)*x</span></code>, which
results in 0.4 when <code class="docutils literal"><span class="pre">x</span></code> is 2.</p>
<p><strong>b)</strong>
Somebody makes another subclass:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">YourLine</span><span class="p">(</span><span class="n">MyLine</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">steepnes_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">2</span>

<span class="n">line</span> <span class="o">=</span> <span class="n">YourLine</span><span class="p">()</span>
<span class="n">x</span> <span class="o">=</span> <span class="mi">2</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;x=</span><span class="si">%g</span><span class="s1">, y=</span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">line</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
</pre></div>
</div>
<p>However, this time the printout is <code class="docutils literal"><span class="pre">x=2,</span> <span class="pre">y=0.4</span></code>, while it should be
<code class="docutils literal"><span class="pre">x=2,</span> <span class="pre">y=5</span></code>. Where is the error?</p>
<p><strong>Solution.</strong>
Doing this by hand might not be successful due to the nature of the error.
It is probably better to use the Online Python Tutor or a debugger.</p>
<iframe width="950" height="500" frameborder="0"
        src="http://pythontutor.com/iframe-embed.html#code=from+__future__+import+print_function%0A%0Aclass+Line%28object%29%3A%0A++++def+__call__%28self%2C+x%29%3A%0A++++++++return+self.constant%28%29+%2B+self.steepness_factor%28%29%2Ax%0A%0A++++def+constant%28self%29%3A%0A++++++++return+1.0%0A%0A++++def+steepness_factor%28self%29%3A%0A++++++++return+1.0%0A%0Aclass+MyLine%28Line%29%3A%0A++++def+steepness_factor%28self%29%3A%0A++++++++return+-0.2%0A%0Aclass+YourLine%28MyLine%29%3A%0A++++def+steepnes_factor%28self%29%3A%0A++++++++return+2%0A%0Aline+%3D+YourLine%28%29%0Ax+%3D+2%0Aprint%28%27x%3D%25g%2C+y%3D%25g%27+%25+%28x%2C+line%28x%29%29%29&curInstr=0&py=2&cumulative=false">
</iframe><p>The problem is that when the method <code class="docutils literal"><span class="pre">Line.__call__</span></code> tries to call
the method <code class="docutils literal"><span class="pre">YourLine.steepness_factor</span></code>, it cannot find such a method in
<code class="docutils literal"><span class="pre">YourLine</span></code>, and instead if uses the inherited method <code class="docutils literal"><span class="pre">Line.steepness_factor</span></code>,
which returns -0.2. The problem is that there is a misspelling: a
missing s in class <code class="docutils literal"><span class="pre">YourLine</span></code>. This is a very common error that can be
hard to track down.</p>
</div>
<div class="section" id="mathematical-problem">
<span id="ch-diffusion-refactor-math"></span><h3>Mathematical problem<a class="headerlink" href="#mathematical-problem" title="Permalink to this headline">¶</a></h3>
<p>We address a variable-coefficient diffusion equation with Dirichlet,
Neumann, and Robin conditions:</p>
<div class="math" id="eq-auto3">
\[\tag{7}
\varrho c{\partial u\over\partial t} = \nabla\cdot\left( \kappa\nabla u\right)
    + f(\boldsymbol{x},t)\hbox{ in }\Omega\times (0,T],\]</div>
<div class="math" id="eq-auto4">
\[\tag{8}
u(\boldsymbol{x},0) = I\hbox{ on }\Omega,\]</div>
<div class="math" id="eq-auto5">
\[\tag{9}
u = u_{_\mathrm{D}}(t)\hbox{ on }\Gamma_D,\]</div>
<div class="math" id="eq-auto6">
\[\tag{10}
-\kappa{\partial u\over\partial n} = g\hbox{ on }\Gamma_N,\]</div>
<div class="math" id="eq-auto7">
\[\tag{11}
-\kappa{\partial u\over\partial n} = r(u-U_s)\hbox{ on }\Gamma_R{\thinspace .}\]</div>
<p>The spatial domain <span class="math">\(\Omega\)</span> has boundary <span class="math">\(\partial\Omega = \Gamma_D\cup
\Gamma_N\cup\Gamma_R\)</span>. We shall assume that all coefficients <span class="math">\(\varrho\)</span>,
<span class="math">\(c\)</span>, <span class="math">\(\kappa\)</span> may vary in space, while <span class="math">\(f\)</span> and <span class="math">\(g\)</span> may vary in time too.
The coefficients <span class="math">\(r\)</span> and <span class="math">\(U_s\)</span> are assumed to depend on time only.</p>
<p>We discretize in time by the general <span class="math">\(\theta\)</span>-rule.  For an evolution
equation <span class="math">\(\partial P/\partial t=Q(t)\)</span>, this rule reads</p>
<div class="math">
\[{P^{n+1} - P^{n}\over{{\Delta t}}} = \theta Q^{n+1} + (1-\theta )Q^{n},\]</div>
<p>where <span class="math">\(\theta\in[0,1]\)</span> is a weighting factor. The attractive property
of this scheme is that <span class="math">\(\theta =1\)</span> corresponds
to the Backward Euler scheme, <span class="math">\(\theta =1/2\)</span> to the Crank-Nicolson
scheme, and <span class="math">\(\theta =0\)</span> to the Forward Euler scheme.</p>
<p>Introducing the <span class="math">\(\theta\)</span>-rule in our PDE results in</p>
<div class="math" id="eq-ch-diffusion-refactor-math-problem">
\[\tag{12}
\varrho c\frac{u^{n+1}-u^n}{{\Delta t}}
    = \theta(\nabla\cdot\left( \kappa\nabla u^{n+1}\right) + f(\boldsymbol{x},t_{n+1})) +
    (1-\theta)(\nabla\cdot\left( \kappa\nabla u^{n}\right) + f(\boldsymbol{x},t_{n})){\thinspace .}\]</div>
<p>A Galerkin method for this initial-boundary value problem consists
of multiplying <a class="reference internal" href="#eq-ch-diffusion-refactor-math-problem"><span class="std std-ref">(12)</span></a> by
a test function <span class="math">\(v\in\hat V\)</span>, integrate over <span class="math">\(\Omega\)</span>, and
perform integration by parts on the second-order derivative term
<span class="math">\(\nabla\cdot\left( \kappa\nabla u\right)\)</span>:</p>
<div class="math">
\[\begin{split}\int\limits_\Omega \bigl(
v\varrho c\frac{u^{n+1}-u^n}{{\Delta t}}{\, \mathrm{d}x}
&amp; + \theta \kappa\nabla u^{n+1}\cdot\nabla v - v\theta f(\boldsymbol{x},t_{n+1} \\
&amp; + (1-\theta) \kappa\nabla u^{n}\cdot\nabla v -
v(1-\theta)f(\boldsymbol{x},t_{n}\bigr){\, \mathrm{d}x}\\
&amp; - \int\limits_{\Gamma_N\cup\Gamma_R}
\bigl(\theta \kappa\frac{\partial u^{n+1}}{\partial n}v
+ (1-\theta) \kappa\frac{\partial u^{n}}{\partial n}v\bigr){\, \mathrm{d}s} = 0
{\thinspace .}\end{split}\]</div>
<p>Inserting the boundary conditions at <span class="math">\(\Gamma_N\)</span> and <span class="math">\(\Gamma_R\)</span>  gives
us</p>
<div class="math">
\[F(u;v) = \int\limits_\Omega \bigl(
v\varrho c\frac{u^{n+1}-u^n}{{\Delta t}}{\, \mathrm{d}x}
+ \theta \kappa\nabla u^{n+1}\cdot\nabla v - v\theta f(\boldsymbol{x},t_{n+1}) \nonumber\]</div>
<div class="math">
\[\quad - (1-\theta) \kappa\nabla u^{n}\cdot\nabla v +
v(1-\theta)f(\boldsymbol{x},t_{n}\bigr){\, \mathrm{d}x}\nonumber\]</div>
<div class="math">
\[\quad + \int\limits_{\Gamma_N}
\bigl(\theta g(\boldsymbol{x},t_{n+1})v
+ (1-\theta) g(\boldsymbol{x},t_n)v\bigr){\, \mathrm{d}s}\nonumber\]</div>
<div class="math" id="eq-ch-diffusion-refactor-math-varform0">
\[\tag{13}
\quad + \int\limits_{\Gamma_R}
    \bigl(\theta r(u^{n+1} - U_s(t_{n+1}))v
    + (1-\theta) r(u^{n} - U_s(t_{n}))v\bigr){\, \mathrm{d}s}
    = 0{\thinspace .}\]</div>
<p>Since we use <code class="docutils literal"><span class="pre">u</span></code> for the unknown <span class="math">\(u^{n+1}\)</span> in the code, and <code class="docutils literal"><span class="pre">u_1</span></code>
for <span class="math">\(u^n\)</span>, we introduce the same notation in the mathematics too:
<span class="math">\(u\)</span> for <span class="math">\(u^{n+1}\)</span> and <span class="math">\(u_1\)</span> for <span class="math">\(u^n\)</span>,</p>
<div class="math">
\[F(u;v) = \int\limits_\Omega \bigl(
v\varrho c\frac{u-u_1}{{\Delta t}}{\, \mathrm{d}x}
+ \theta \kappa\nabla u\cdot\nabla v - v\theta f(\boldsymbol{x},t_{n+1}) \nonumber\]</div>
<div class="math">
\[\quad - (1-\theta) \kappa\nabla u_1\cdot\nabla v +
v(1-\theta)f(\boldsymbol{x},t_{n}\bigr){\, \mathrm{d}x}\nonumber\]</div>
<div class="math">
\[\quad + \int\limits_{\Gamma_N}
\bigl(\theta g(\boldsymbol{x},t_{n+1})v
+ (1-\theta) g(\boldsymbol{x},t_n)v\bigr){\, \mathrm{d}s}\nonumber\]</div>
<div class="math" id="eq-ch-diffusion-refactor-math-varform">
\[\tag{14}
\quad + \int\limits_{\Gamma_R}
    \bigl(\theta r(u - U_s(t_{n+1}))v
    + (1-\theta) r(u_1 - U_s(t_{n}))v\bigr){\, \mathrm{d}s}
    = 0{\thinspace .}\]</div>
<p>The variational formulation is then: at each time level, find <span class="math">\(u\in V\)</span>
such that <span class="math">\(F(u;v)=0\ \forall v\in\hat V\)</span>.  We do not need to identify
the bilinear and linear terms in the expression <span class="math">\(F\)</span> since we can use
the <code class="docutils literal"><span class="pre">lhs</span></code> and <code class="docutils literal"><span class="pre">rhs</span></code> functions for this purpose in the code.  However,
we should be very convinced that we have a <em>linear</em> variational
problem at hand and not a nonlinear one.</p>
</div>
<div class="section" id="superclass-for-problems">
<span id="ch-diffusion-refactor-class-solver"></span><h3>Superclass for problems<a class="headerlink" href="#superclass-for-problems" title="Permalink to this headline">¶</a></h3>
<p>The solver class contains the data structures
and actions from previous programs, but needs to ask the problem class
about the mesh, boundary conditions, the time step, and so forth. We
therefore need to define the API of the problem class first so we know
how the solver class can ask for the mesh, for instance.</p>
<p>Here is an abstract problem class:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DiffusionProblem</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Abstract base class for specific diffusion applications.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solver_class</span><span class="o">=</span><span class="n">DiffusionSolver</span><span class="p">,</span>
              <span class="n">theta</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linear_solver</span><span class="o">=</span><span class="s1">&#39;direct&#39;</span><span class="p">,</span>
              <span class="n">abs_tol</span><span class="o">=</span><span class="mf">1E-6</span><span class="p">,</span> <span class="n">rel_tol</span><span class="o">=</span><span class="mf">1E-5</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Solve the PDE problem for the primary unknown.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="n">solver_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>
        <span class="n">iterative_solver</span> <span class="o">=</span> <span class="n">KrylovSolver</span><span class="p">(</span><span class="s1">&#39;gmres&#39;</span><span class="p">,</span> <span class="s1">&#39;ilu&#39;</span><span class="p">)</span>
        <span class="n">prm</span> <span class="o">=</span> <span class="n">iterative_solver</span><span class="o">.</span><span class="n">parameters</span>
        <span class="n">prm</span><span class="p">[</span><span class="s1">&#39;absolute_tolerance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">abs_tol</span>
        <span class="n">prm</span><span class="p">[</span><span class="s1">&#39;relative_tolerance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rel_tol</span>
        <span class="n">prm</span><span class="p">[</span><span class="s1">&#39;maximum_iterations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_iter</span>
        <span class="n">prm</span><span class="p">[</span><span class="s1">&#39;nonzero_initial_guess&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>  <span class="c1"># Use u (last sol.)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">flux</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute and return flux -p*grad(u).&quot;&quot;&quot;</span>
        <span class="n">degree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">()</span><span class="o">.</span><span class="n">ufl_element</span><span class="p">()</span><span class="o">.</span><span class="n">degree</span><span class="p">()</span>
        <span class="n">V_g</span> <span class="o">=</span> <span class="n">VectorFunctionSpace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="n">degree</span><span class="p">)</span>
        <span class="n">flux_u</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">heat_conduction</span><span class="p">()</span><span class="o">*</span><span class="n">grad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flux_u</span> <span class="o">=</span> <span class="n">project</span><span class="p">(</span><span class="n">flux_u</span><span class="p">,</span> <span class="n">V_g</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flux_u</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;flux(u)&#39;</span><span class="p">,</span> <span class="s1">&#39;continuous flux field&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux_u</span>

    <span class="k">def</span> <span class="nf">mesh_degree</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return mesh, degree.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Must implement mesh&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">I</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return initial condition.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">heat_conduction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># kappa</span>
        <span class="k">return</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">density</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>          <span class="c1"># rho</span>
        <span class="k">return</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">heat_capacity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>    <span class="c1"># c</span>
        <span class="k">return</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">heat_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>   <span class="c1"># f</span>
        <span class="k">return</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">time_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">NotImplentedError</span><span class="p">(</span><span class="s1">&#39;Must implement time_step&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">end_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">NotImplentedError</span><span class="p">(</span><span class="s1">&#39;Must implement end_time&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">solution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">u</span>

    <span class="k">def</span> <span class="nf">user_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">u</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Post process solution u at time t.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">Dirichlet_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return either an Expression (for the entire boundary) or</span>
<span class="sd">        a list of (value,boundary_parts,index) triplets.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">Neumann_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return list of (g,ds(n)) pairs.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">Robin_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return list of (r,s,ds(n)) triplets.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span>
</pre></div>
</div>
<p>The meaning of the different methods in this class will be evident as
we present specific examples on implementations.</p>
<p>The idea now is that different problems are implemented as different
subclasses of <code class="docutils literal"><span class="pre">DiffusionProblem</span></code>. The <code class="docutils literal"><span class="pre">solve</span></code> and <code class="docutils literal"><span class="pre">flux</span></code> methods are
general and can be inherited, while the rest of the methods must be
implemented in the subclass for the particular problem at hand.</p>
</div>
<div class="section" id="a-specific-problem-class">
<h3>A specific problem class<a class="headerlink" href="#a-specific-problem-class" title="Permalink to this headline">¶</a></h3>
<p>As a simple example, consider the test problem where we have a
manufactured solution <span class="math">\(u=1+x^2 + \alpha y^2 + \beta t\)</span> on
a uniform mesh over the unit square or cube, with Dirichlet conditions
on the entire boundary. Suppose we have <span class="math">\({\Delta t}=0.3\)</span> and
want to simulate for <span class="math">\(t\in [0,0.9]\)</span>. A problem class is then</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TestProblemExact</span><span class="p">(</span><span class="n">DiffusionProblem</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Nx</span><span class="p">,</span> <span class="n">Ny</span><span class="p">,</span> <span class="n">Nz</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_time_steps</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">Nz</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">UnitSquareMesh</span><span class="p">(</span><span class="n">Nx</span><span class="p">,</span> <span class="n">Ny</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">UnitCubeMesh</span><span class="p">(</span><span class="n">Nx</span><span class="p">,</span> <span class="n">Ny</span><span class="p">,</span> <span class="n">Nz</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">degree</span> <span class="o">=</span> <span class="n">degree</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_time_steps</span> <span class="o">=</span> <span class="n">num_time_steps</span>

        <span class="n">alpha</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="n">beta</span> <span class="o">=</span> <span class="mf">1.2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u0</span> <span class="o">=</span> <span class="n">Expression</span><span class="p">(</span>
            <span class="s1">&#39;1 + x[0]*x[0] + alpha*x[1]*x[1] + beta*t&#39;</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="n">beta</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">alpha</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">time_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="k">return</span> <span class="mf">0.3</span>

    <span class="k">def</span> <span class="nf">end_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_time_steps</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">mesh_degree</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">degree</span>

    <span class="k">def</span> <span class="nf">I</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return initial condition.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">u0</span>

    <span class="k">def</span> <span class="nf">heat_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span>

    <span class="k">def</span> <span class="nf">Dirichlet_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u0</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">t</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">u0</span>

    <span class="k">def</span> <span class="nf">user_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">timestep</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Post process solution u at time t.&quot;&quot;&quot;</span>
        <span class="n">u_e</span> <span class="o">=</span> <span class="n">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u0</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">function_space</span><span class="p">())</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u_e</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">array</span><span class="p">()</span> <span class="o">-</span>
                       <span class="n">u</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">array</span><span class="p">())</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;error at </span><span class="si">%g</span><span class="s1">: </span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">error</span><span class="p">))</span>
        <span class="n">tol</span> <span class="o">=</span> <span class="mf">2E-11</span>
        <span class="k">assert</span> <span class="n">error</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">,</span> <span class="s1">&#39;max_error: </span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">error</span>
</pre></div>
</div>
<p>Remember that we can inherit all methods from the parent class that are
appropriate for the problem at hand.</p>
<p>Our test problem can now be solved in (e.g.) a unit test like</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_DiffusionSolver</span><span class="p">():</span>
    <span class="n">problem</span> <span class="o">=</span> <span class="n">TestProblemExact</span><span class="p">(</span><span class="n">Nx</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">Ny</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">problem</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">theta</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linear_solver</span><span class="o">=</span><span class="s1">&#39;direct&#39;</span><span class="p">)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">solution</span><span class="p">()</span>
</pre></div>
</div>
<p>The solver class will call the <code class="docutils literal"><span class="pre">user_action</span></code> function at every time level,
and this function will assert that we recover the solution to machine precision.</p>
</div>
<div class="section" id="the-solver-class-2">
<h3>The solver class<a class="headerlink" href="#the-solver-class-2" title="Permalink to this headline">¶</a></h3>
<p>The solver class, here based on the <span class="math">\(\theta\)</span>-rule and the
variational formulation from the previous section, can be coded as
follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DiffusionSolver</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Solve a heat conduction problem by the theta-rule.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">problem</span> <span class="o">=</span> <span class="n">problem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theta</span> <span class="o">=</span> <span class="n">theta</span>

    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run time loop.&quot;&quot;&quot;</span>
        <span class="n">tol</span> <span class="o">=</span> <span class="mf">1E-14</span>
        <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">end_time</span><span class="p">()</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">time_step</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_condition</span><span class="p">()</span>
        <span class="n">timestep</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">while</span> <span class="n">t</span> <span class="o">&lt;=</span> <span class="n">T</span><span class="o">+</span><span class="n">tol</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">user_action</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="n">timestep</span><span class="p">)</span>

            <span class="c1"># Updates</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">time_step</span><span class="p">(</span>
                <span class="n">t</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">time_step</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span>
            <span class="n">timestep</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">u_1</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">initial_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">degree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">mesh_degree</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="o">=</span> <span class="n">V</span> <span class="o">=</span> <span class="n">FunctionSpace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="n">degree</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span> <span class="s1">&#39;I_project&#39;</span><span class="p">):</span>
            <span class="n">I_project</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span> <span class="s1">&#39;I_project&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">I_project</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u_1</span> <span class="o">=</span> <span class="n">project</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">I</span><span class="p">(),</span> <span class="n">V</span><span class="p">)</span> <span class="k">if</span> <span class="n">I_project</span> \
                   <span class="k">else</span> <span class="n">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">I</span><span class="p">(),</span> <span class="n">V</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u_1</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s1">&#39;initial condition&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u_1</span> <span class="c1"># needed if flux is computed in the next step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">user_action</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">u_1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">linear_solver</span><span class="o">=</span><span class="s1">&#39;direct&#39;</span><span class="p">,</span>
             <span class="n">abs_tol</span><span class="o">=</span><span class="mf">1E-6</span><span class="p">,</span> <span class="n">rel_tol</span><span class="o">=</span><span class="mf">1E-5</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Advance solution one time step.&quot;&quot;&quot;</span>
        <span class="c1"># Find new Dirichlet conditions at this time step</span>
        <span class="n">Dirichlet_cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">Dirichlet_conditions</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Dirichlet_cond</span><span class="p">,</span> <span class="n">Expression</span><span class="p">):</span>
            <span class="c1"># Just one Expression for Dirichlet conditions on</span>
            <span class="c1"># the entire boundary</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bcs</span> <span class="o">=</span> <span class="p">[</span><span class="n">DirichletBC</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">,</span> <span class="n">Dirichlet_cond</span><span class="p">,</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">on_boundary</span><span class="p">:</span> <span class="n">on_boundary</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Boundary SubDomain markers</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bcs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">DirichletBC</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">boundaries</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">value</span><span class="p">,</span> <span class="n">boundaries</span><span class="p">,</span> <span class="n">index</span>
                <span class="ow">in</span> <span class="n">Dirichlet_cond</span><span class="p">]</span>

        <span class="c1">#debug_Dirichlet_conditions(self.bcs, self.mesh, self.V)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">define_variational_problem</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">lhs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">),</span> <span class="n">rhs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">)</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">assemble</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">assemble</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>

        <span class="p">[</span><span class="n">bc</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">bc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bcs</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;A:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">A</span><span class="o">.</span><span class="n">array</span><span class="p">(),</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">b:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">array</span><span class="p">())</span>

        <span class="c1"># Solve linear system</span>
        <span class="k">if</span> <span class="n">linear_solver</span> <span class="o">==</span> <span class="s1">&#39;direct&#39;</span><span class="p">:</span>
            <span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">vector</span><span class="p">(),</span> <span class="n">b</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">solver</span> <span class="o">=</span> <span class="n">KrylovSolver</span><span class="p">(</span><span class="s1">&#39;gmres&#39;</span><span class="p">,</span> <span class="s1">&#39;ilu&#39;</span><span class="p">)</span>
            <span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">vector</span><span class="p">(),</span> <span class="n">b</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">define_variational_problem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set up variational problem at time t.&quot;&quot;&quot;</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">TrialFunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">TestFunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span>

        <span class="n">dt</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">time_step</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">kappa</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">heat_conduction</span><span class="p">()</span>
        <span class="n">varrho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">density</span><span class="p">()</span>
        <span class="n">c</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">heat_capacity</span><span class="p">()</span>
        <span class="n">f</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">heat_source</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">f_1</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">heat_source</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="n">dt</span><span class="p">)</span>

        <span class="n">theta</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">)</span>
        <span class="n">u_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u_1</span>  <span class="c1"># first computed in initial_condition</span>

        <span class="n">F</span> <span class="o">=</span> <span class="n">varrho</span><span class="o">*</span><span class="n">c</span><span class="o">*</span><span class="p">(</span><span class="n">u</span> <span class="o">-</span> <span class="n">u_1</span><span class="p">)</span><span class="o">/</span><span class="n">dt</span><span class="o">*</span><span class="n">v</span>
        <span class="n">F</span> <span class="o">+=</span> <span class="n">theta</span>    <span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">kappa</span><span class="o">*</span><span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">),</span>   <span class="n">grad</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
        <span class="n">F</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">kappa</span><span class="o">*</span><span class="n">grad</span><span class="p">(</span><span class="n">u_1</span><span class="p">),</span> <span class="n">grad</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
        <span class="n">F</span> <span class="o">-=</span> <span class="n">theta</span><span class="o">*</span><span class="n">f</span><span class="o">*</span><span class="n">v</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">f_1</span><span class="o">*</span><span class="n">v</span>
        <span class="n">F</span> <span class="o">=</span> <span class="n">F</span><span class="o">*</span><span class="n">dx</span>
        <span class="n">F</span> <span class="o">+=</span> <span class="n">theta</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span>
            <span class="p">[</span><span class="n">g</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="n">ds_</span>
             <span class="k">for</span> <span class="n">g</span><span class="p">,</span> <span class="n">ds_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">Neumann_conditions</span><span class="p">(</span><span class="n">t</span><span class="p">)])</span>
        <span class="n">F</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span>
            <span class="p">[</span><span class="n">g</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="n">ds_</span>
             <span class="k">for</span> <span class="n">g</span><span class="p">,</span> <span class="n">ds_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">Neumann_conditions</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="n">dt</span><span class="p">)])</span>
        <span class="n">F</span> <span class="o">+=</span> <span class="n">theta</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span>
            <span class="p">[</span><span class="n">r</span><span class="o">*</span><span class="p">(</span><span class="n">u</span> <span class="o">-</span> <span class="n">U_s</span><span class="p">)</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="n">ds_</span>
             <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">U_s</span><span class="p">,</span> <span class="n">ds_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">Robin_conditions</span><span class="p">(</span><span class="n">t</span><span class="p">)])</span>
        <span class="n">F</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span>
            <span class="p">[</span><span class="n">r</span><span class="o">*</span><span class="p">(</span><span class="n">u</span> <span class="o">-</span> <span class="n">U_s</span><span class="p">)</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="n">ds_</span>
             <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">U_s</span><span class="p">,</span> <span class="n">ds_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">Robin_conditions</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="n">dt</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">F</span> <span class="o">=</span> <span class="n">F</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s1">&#39;solution&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="applications-to-heat-conduction">
<h2>Applications to heat conduction<a class="headerlink" href="#applications-to-heat-conduction" title="Permalink to this headline">¶</a></h2>
<p>We shall now through some real physical examples show how the problem
classes can be constructed for various types of applications.
The goal is to achieve PDE solvers that are flexible and convenient for
performing scientific investigations.</p>
<div class="section" id="thermal-boundary-layer">
<h3>Thermal boundary layer<a class="headerlink" href="#thermal-boundary-layer" title="Permalink to this headline">¶</a></h3>
<p>Assume we have some medium at temperature <span class="math">\(U_s\)</span> and then we suddenly
heat one end so the temperature here stays constant at <span class="math">\(U_1\)</span>. At the
other end we have some equipment to keep the temperature constant at
<span class="math">\(U_s\)</span>. The other boundaries are insulated so heat cannot escape.
There are no heat sources.  How is the temperature development
in the material due to such sudden heating of one end?
Figure <a class="reference internal" href="#ch-diffusion-refactor-class-solver-fig4"><span class="std std-ref">Domain with (scaled) boundary conditions: sudden jump in  \( u \)  at the left boundary</span></a> sketches the
situation (with a scaled variable <span class="math">\(u\)</span> that jumps from 0 to 1).</p>
<div class="figure" id="id6">
<span id="ch-diffusion-refactor-class-solver-fig4"></span><a class="reference internal image-reference" href="_images/thermal_layer1_sketch.png"><img alt="_images/thermal_layer1_sketch.png" src="_images/thermal_layer1_sketch.png" style="width: 500px;" /></a>
<p class="caption"><span class="caption-text"><em>Domain with (scaled) boundary conditions: sudden jump in  \( u \)  at the left boundary</em></span></p>
</div>
<div class="section" id="mathematics">
<h4>Mathematics<a class="headerlink" href="#mathematics" title="Permalink to this headline">¶</a></h4>
<p>The problem is mathematically one-dimensional, so it means that if we
create a 2D or 3D domain, the boundaries in <span class="math">\(y\)</span> and <span class="math">\(z\)</span> directions are
insulated (requiring <span class="math">\(\partial u/\partial n=0\)</span> as boundary condition
on <span class="math">\(y=\mathrm{const}\)</span> and <span class="math">\(z=\mathrm{const}\)</span>).
The heating is applied to <span class="math">\(x=0\)</span> and <span class="math">\(x=L\)</span>.</p>
<p>It is natural to scale the problem by introducing dimensionless
independent and dependent variables:</p>
<div class="math">
\[\bar x = \frac{x}{L},\quad \bar y = \frac{y}{L},\quad
\bar u = \frac{u-U_s}{U_1-U_s},\quad \bar t = \frac{t}{t_c}{\thinspace .}\]</div>
<p>The suggested scaling for <span class="math">\(u\)</span> makes a simple boundary condition at <span class="math">\(x=0\)</span>:
<span class="math">\(\bar u = 1\)</span>. This scaling also results in <span class="math">\(\bar u \in [0,1]\)</span> as is
always desired.</p>
<p>After inserting the dimensionless variables in the PDE, we demand the
time-derivative term and the heat conduction term to balance, and
find <span class="math">\(t_c\)</span> from that condition: <span class="math">\(t_c = \varrho c L^2/\kappa\)</span>.</p>
<p>The spatial domain is the unit square. We introduce the boundaries
<span class="math">\(\Gamma_{D_1}\)</span> as the side <span class="math">\(x=0\)</span>, <span class="math">\(\Gamma_{D_2}\)</span> as the side <span class="math">\(x=1\)</span>,
and <span class="math">\(\Gamma_N\)</span> as the rest of the boundary.
The scaled initial-boundary problem can be written as</p>
<div class="math" id="eq-auto8">
\[\tag{15}
\frac{\partial\bar u}{\partial\bar t} = \bar\nabla^2\bar u\hbox{ in }
    \Omega = (0,1)\times (0,1)\times (0,T],\]</div>
<div class="math" id="eq-auto9">
\[\tag{16}
\bar u(\boldsymbol{x}, 0) = 0\hbox{ in }\Omega,\]</div>
<div class="math" id="eq-auto10">
\[\tag{17}
\bar u = 1\hbox{ at } \Gamma_{D_1},\]</div>
<div class="math" id="eq-auto11">
\[\tag{18}
\bar u = 0\hbox{ at } \Gamma_{D_2},\]</div>
<div class="math" id="eq-auto12">
\[\tag{19}
\frac{\partial\bar u}{\partial\bar n} = 0\hbox{ at }\Gamma_N{\thinspace .}\]</div>
</div>
<div class="section" id="fenics-implementation-2">
<h4>FEniCS implementation<a class="headerlink" href="#fenics-implementation-2" title="Permalink to this headline">¶</a></h4>
<p>We can solve our problem with the general problem and solver
classes by setting <span class="math">\(\varrho = c= \kappa = 1\)</span>,
and <span class="math">\(I=0\)</span>. The most labor-intensive part of the problem class is
the visualization. We can create a helper class, <code class="docutils literal"><span class="pre">ProcessSolution</span></code>,
which applies <code class="docutils literal"><span class="pre">cbcpost</span></code> to store the solution and perform animation
via the <code class="docutils literal"><span class="pre">fenics.plot</span></code> tool:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">cbcpost</span> <span class="kn">as</span> <span class="nn">post</span>
<span class="k">class</span> <span class="nc">ProcessSolution</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;user_action function for storing the solution and flux.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">,</span> <span class="n">u_min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">u_max</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Define fields to be stored/plotted.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">problem</span> <span class="o">=</span> <span class="n">problem</span>  <span class="c1"># this user_action belongs to problem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pp</span> <span class="o">=</span> <span class="n">post</span><span class="o">.</span><span class="n">PostProcessor</span><span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">casedir</span><span class="o">=</span><span class="s1">&#39;Results&#39;</span><span class="p">,</span> <span class="n">clean_casedir</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span>
            <span class="n">post</span><span class="o">.</span><span class="n">SolutionField</span><span class="p">(</span>
                <span class="s1">&#39;Solution&#39;</span><span class="p">,</span>
                <span class="nb">dict</span><span class="p">(</span><span class="n">save</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                     <span class="n">save_as</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;hdf5&#39;</span><span class="p">,</span> <span class="s1">&#39;xdmf&#39;</span><span class="p">],</span>  <span class="c1"># format</span>
                     <span class="n">plot</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                     <span class="n">plot_args</span><span class="o">=</span>
                     <span class="nb">dict</span><span class="p">(</span><span class="n">range_min</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">u_min</span><span class="p">),</span>
                          <span class="n">range_max</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">u_max</span><span class="p">))</span>
                     <span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span>
            <span class="n">post</span><span class="o">.</span><span class="n">SolutionField</span><span class="p">(</span>
                <span class="s2">&quot;Flux&quot;</span><span class="p">,</span>
                <span class="nb">dict</span><span class="p">(</span><span class="n">save</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                     <span class="n">save_as</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;hdf5&quot;</span><span class="p">,</span> <span class="s2">&quot;xdmf&quot;</span><span class="p">],</span>  <span class="c1"># format</span>
                     <span class="p">)))</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">timestep</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Store u and its flux to file.&quot;&quot;&quot;</span>
        <span class="n">u</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s1">&#39;Solution&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">update_all</span><span class="p">(</span>
            <span class="p">{</span><span class="s1">&#39;Solution&#39;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">u</span><span class="p">,</span>
             <span class="s1">&#39;Flux&#39;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">flux</span><span class="p">()},</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">timestep</span><span class="p">)</span>
        <span class="n">info</span><span class="p">(</span><span class="s1">&#39;saving results at time </span><span class="si">%g</span><span class="s1">, max u: </span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span>
             <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">array</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
</pre></div>
</div>
<p>In the <code class="docutils literal"><span class="pre">user_action</span></code>
method, we use this tool to store the solution, but we also add
statements for plotting <span class="math">\(u\)</span> along a line from <span class="math">\(x=0\)</span> to <span class="math">\(x=1\)</span>
through the medium (<span class="math">\(y=0.5\)</span>). This gives an animation of
the temperature profile, but results in somewhat lengthy code.</p>
<p>To mark the boundaries, so we can set <span class="math">\(u=1\)</span> at <span class="math">\(x=0\)</span>, we can make a
function like <code class="docutils literal"><span class="pre">mark_boundaries_in_hypercube</span></code> as shown in
the section <a class="reference internal" href="._ftut2001.html#ch-diffusion-opt-markboundary"><span class="std std-ref">Marking the boundary</span></a>.
Eventually, we are in a position to show the complete problem class:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Problem1</span><span class="p">(</span><span class="n">DiffusionProblem</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Evolving boundary layer, I=0, but u=1 at x=0.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Nx</span><span class="p">,</span> <span class="n">Ny</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">make_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Nx</span><span class="p">,</span> <span class="n">Ny</span><span class="p">)</span>
        <span class="c1"># Storage and visualization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_action_object</span> <span class="o">=</span> \
                   <span class="n">ProcessSolution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u_min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">u_max</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Compare u(x,t) as curve plots for the following times</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">times4curveplots</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">4</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
            <span class="mi">8</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">12</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
            <span class="mi">16</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>  <span class="c1"># for animation</span>

    <span class="k">def</span> <span class="nf">make_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Nx</span><span class="p">,</span> <span class="n">Ny</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize mesh, boundary parts, and p.&quot;&quot;&quot;</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;XXX in Problem1.make_mesh&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">UnitSquareMesh</span><span class="p">(</span><span class="n">Nx</span><span class="p">,</span> <span class="n">Ny</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">divisions</span> <span class="o">=</span> <span class="p">(</span><span class="n">Nx</span><span class="p">,</span> <span class="n">Ny</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">boundary_parts</span> <span class="o">=</span> \
             <span class="n">mark_boundaries_in_hypercube</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="o">=</span>  <span class="n">Measure</span><span class="p">(</span>
            <span class="s1">&#39;ds&#39;</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
            <span class="n">subdomain_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_parts</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">time_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="c1"># Small time steps in the beginning when the boundary</span>
        <span class="c1"># layer develops</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mf">0.02</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0005</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.025</span>

    <span class="k">def</span> <span class="nf">end_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mf">0.3</span>

    <span class="k">def</span> <span class="nf">mesh_degree</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">Dirichlet_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return list of (value,boundary) pairs.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[(</span><span class="mf">1.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_parts</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_parts</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">user_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">timestep</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Post process solution u at time t.&quot;&quot;&quot;</span>
        <span class="n">tol</span> <span class="o">=</span> <span class="mf">1E-14</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_action_object</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">timestep</span><span class="p">)</span>
        <span class="c1"># Also plot u along line y=1/2</span>
        <span class="n">x_coor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">tol</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">tol</span><span class="p">,</span> <span class="mi">101</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x_</span><span class="p">,</span><span class="mf">0.5</span><span class="p">)</span> <span class="k">for</span> <span class="n">x_</span> <span class="ow">in</span> <span class="n">x_coor</span><span class="p">]</span>
        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">()</span>
        <span class="n">u_line</span> <span class="o">=</span> <span class="p">[</span><span class="n">u</span><span class="p">(</span><span class="n">x_</span><span class="p">)</span> <span class="k">for</span> <span class="n">x_</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
        <span class="c1"># Animation in figure(1)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">timestep</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_coor</span><span class="p">,</span> <span class="n">u_line</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;u, t=</span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">t</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Solution along y=1/2, time step: </span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">),</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;tmp_</span><span class="si">%04d</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="n">timestep</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">u_line</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Solution along y=1/2, time step: </span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;tmp_</span><span class="si">%04d</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="n">timestep</span><span class="p">)</span>
        <span class="c1"># Accumulated selected curves in one plot in figure(2)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">times4curveplots</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_coor</span><span class="p">,</span> <span class="n">u_line</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;u, t=</span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">t</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">hold</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Notice our definition of the time step: because the growth of the
thin boundary layer close to <span class="math">\(x=0\)</span>
is very rapid for small times, we need to start with a small time
step. Nevertheless, the speed of the heat transfer slows down with time,
so we decide to use a longer time step after <span class="math">\(t=0.02\)</span>. The animation
would otherwise also be boring to watch, but be aware of the fact that
the apparent speed of the physical process is dramatically increased in the
animation at <span class="math">\(t=0.02\)</span>.</p>
<p>The problem is solved by</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">demo_Problem1</span><span class="p">():</span>
    <span class="n">problem</span> <span class="o">=</span> <span class="n">Problem1</span><span class="p">(</span><span class="n">Nx</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">Ny</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">problem</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">theta</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linear_solver</span><span class="o">=</span><span class="s1">&#39;direct&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;tmp1.png&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;tmp1.pdf&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="results-1">
<h4>Results<a class="headerlink" href="#results-1" title="Permalink to this headline">¶</a></h4>
<p>Figure <a class="reference internal" href="#ch-diffusion-refactor-class-solver-fig1"><span class="std std-ref">Development of thermal boundary layer: Crank-Nicolson (left) and Backward Euler (right) schemes</span></a> shows accumulated
curves (from <code class="docutils literal"><span class="pre">plt.figure(2)</span></code>). The problem is a
primary example on a <em>thermal boundary layer</em>: the sudden rise in
temperature at <span class="math">\(x=0\)</span> at <span class="math">\(t=0\)</span> gives rise to a very steep function, and
a thin boundary layer that grows with time as heat is transported from
the boundary into the domain. The jump in the temperature profile at
<span class="math">\(x=0\)</span> makes demands to the numerical methods. Quite typically, a
Crank-Nicolson scheme may show oscillations (as we can see in the
first curve) because of inaccurate treatment of the shortest spatial
waves in the Fourier representation of the discrete solution.  The
oscillations are removed by doubling the spatial resolution from 20 to
40 elements in the <span class="math">\(x\)</span> direction.  With <span class="math">\(\theta=1\)</span>, we never
experience any oscillations, but the boundary layer gets thicker and
less accurate (smaller <span class="math">\({\Delta t}\)</span> is needed to compensate).
However, in this problem, we see from Figure <a class="reference internal" href="#ch-diffusion-refactor-class-solver-fig1"><span class="std std-ref">Development of thermal boundary layer: Crank-Nicolson (left) and Backward Euler (right) schemes</span></a> that the inaccuracy is only visible for the very first time
steps as the boundary layer is thin.</p>
<div class="figure" id="id7">
<span id="ch-diffusion-refactor-class-solver-fig1"></span><a class="reference internal image-reference" href="_images/thermal_layer1.png"><img alt="_images/thermal_layer1.png" src="_images/thermal_layer1.png" style="width: 800px;" /></a>
<p class="caption"><span class="caption-text"><em>Development of thermal boundary layer: Crank-Nicolson (left) and Backward Euler (right) schemes</em></span></p>
</div>
<p>From all the plot frames with filenames <code class="docutils literal"><span class="pre">tmp_%04d.png</span></code> we may create
video files by</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>Terminal&gt; ffmpeg -i tmp_%04d.png -r 25 -vcodec libx264   movie.mp4
Terminal&gt; ffmpeg -i tmp_%04d.png -r 25 -vcodec libtheora movie.ogg
</pre></div>
</div>
<div>
<video  loop controls width='640' height='365' preload='none'>
    <source src="_static/mov/thermal_layer1/movie.mp4"  type='video/mp4;  codecs="avc1.42E01E, mp4a.40.2"'>
    <source src="_static/mov/thermal_layer1/movie.webm" type='video/webm; codecs="vp8, vorbis"'>
    <source src="_static/mov/thermal_layer1/movie.ogg"  type='video/ogg;  codecs="theora, vorbis"'>
</video>
</div>
<p><em>Developing thermal boundary layer (notice the jump in speed, i.e., time step!)</em></p>

<!-- Issue warning if in a Safari browser -->
<script language="javascript">
if (!!(window.safari)) {
  document.write("<div style=\"width: 95%%; padding: 10px; border: 1px solid #100; border-radius: 4px;\"><p><font color=\"red\">The above movie will not play in Safari - use Chrome, Firefox, or Opera.</font></p></div>")}
</script></div>
</div>
<div class="section" id="extension-to-a-heterogeneous-medium">
<h3>Extension to a heterogeneous medium<a class="headerlink" href="#extension-to-a-heterogeneous-medium" title="Permalink to this headline">¶</a></h3>
<p>Suppose we now place another material inside the domain with other
values material properties (i.e., values of <span class="math">\(\varrho\)</span>, <span class="math">\(c\)</span>, and
<span class="math">\(\kappa\)</span>).  The new material occupies the rectangle <span class="math">\([0.3,0.7]\times
[0.3,0.7]\)</span> inside the scaled domain.  We also change the boundary
condition at <span class="math">\(x=1\)</span> to be &#8220;no change&#8221;, i.e., <span class="math">\(\partial u/\partial
n=0\)</span>. Figure <a class="reference internal" href="#ch-diffusion-refactor-class-solver-fig5"><span class="std std-ref">Domain with internal subdomain and (scaled) boundary conditions</span></a> depicts the
problem.</p>
<div class="figure" id="id8">
<span id="ch-diffusion-refactor-class-solver-fig5"></span><a class="reference internal image-reference" href="_images/thermal_layer2_sketch.png"><img alt="_images/thermal_layer2_sketch.png" src="_images/thermal_layer2_sketch.png" style="width: 500px;" /></a>
<p class="caption"><span class="caption-text"><em>Domain with internal subdomain and (scaled) boundary conditions</em></span></p>
</div>
<div class="section" id="updated-scaling">
<h4>Updated scaling<a class="headerlink" href="#updated-scaling" title="Permalink to this headline">¶</a></h4>
<p>The former scaling is not completely valid as it was based on constant
<span class="math">\(\varrho\)</span>, <span class="math">\(c\)</span>, and <span class="math">\(\kappa\)</span>. We now introduce</p>
<div class="math">
\[\bar\varrho = \frac{\varrho}{\varrho_0},\quad
\bar c = \frac{c}{c_0},\quad \bar\kappa = \frac{\kappa}{\kappa_0},\]</div>
<p>where <span class="math">\(\varrho_0\)</span> is the value of <span class="math">\(\varrho\)</span> in the outer material,
now to be known as subdomain 0.
A similar parameter <span class="math">\(\varrho_1\)</span> is the value of <span class="math">\(\varrho\)</span> inside
the new material, called subdomain 1.
The constants <span class="math">\(c_0\)</span>, <span class="math">\(\kappa_0\)</span>, <span class="math">\(c_1\)</span>, and <span class="math">\(\kappa_1\)</span> are
defined similarly. In subdomain 0, <span class="math">\(\bar\varrho = 1\)</span>, and in subdomain 1,
<span class="math">\(\bar\varrho = \varrho_1/\varrho_0\)</span>, with similar values for
<span class="math">\(\bar c\)</span> and <span class="math">\(\bar\kappa\)</span>. The scaled PDE becomes</p>
<div class="math">
\[\bar\varrho\bar c\frac{\partial\bar u}{\partial\bar t}
= \bar\nabla\cdot(\bar\kappa\bar\nabla\bar u) + \bar f{\thinspace .}\]</div>
<p>We can call up the solver for the problem with dimensions as long
as we remember to set <span class="math">\(\kappa = \varrho = c =1\)</span> in subdomain 0.
In subdomain 1, we divide by <span class="math">\(\bar\varrho = \varrho_1/\varrho_0\)</span>
and <span class="math">\(\bar c = c_1/c_0\)</span>, which results in a coefficient</p>
<div class="math">
\[\alpha = \frac{\varrho_0c_0\kappa_1}{\varrho_1 c_1\kappa_0}\]</div>
<p>on the right-hand side. This means that we can let <code class="docutils literal"><span class="pre">density</span></code> and
<code class="docutils literal"><span class="pre">heat_capacity</span></code> be of unit value and only operate with a spatially
varying <span class="math">\(\kappa\)</span>, which takes on the values 1 in subdomain 0 and
<span class="math">\(\alpha\)</span> in subdomain 1. For simplicity, we just name this parameter
<code class="docutils literal"><span class="pre">kappa_values</span></code> in the code.</p>
<p>[<strong>hpl 7</strong>: Is this trick too tricky? Would it be clearer to let all three parameters vary?]</p>
</div>
<div class="section" id="the-problem-class-1">
<h4>The problem class<a class="headerlink" href="#the-problem-class-1" title="Permalink to this headline">¶</a></h4>
<p>The problem class is very similar to <code class="docutils literal"><span class="pre">Problem1</span></code> above, except for the
fact that we need to define the inner subdomain, we need to allow for
<span class="math">\(\kappa\)</span> values in subdomain 0 and 1, the time points
for plots and time steps are a bit different, and the Dirichlet condition
only applies to <span class="math">\(x=0\)</span> (no need to implement the Neumann condition as
long as it is zero).</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Problem2</span><span class="p">(</span><span class="n">Problem1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;As Problem 1, but du/dn at x=1 and varying kappa.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Nx</span><span class="p">,</span> <span class="n">Ny</span><span class="p">,</span> <span class="n">kappa_values</span><span class="p">,</span> <span class="n">subdomain_corners</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Nx x Ny mesh. kappa_values=[1,a],</span>
<span class="sd">        subdomain_corners=[(0.3,0.3), (0.7,0.9)]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">make_mesh</span><span class="p">(</span><span class="n">Nx</span><span class="p">,</span> <span class="n">Ny</span><span class="p">,</span> <span class="n">kappa_values</span><span class="p">,</span> <span class="n">subdomain_corners</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_action_object</span> <span class="o">=</span> \
                   <span class="n">ProcessSolution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u_min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">u_max</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Compare u(x,t) as curve plots for the following times</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">times4curveplots</span> <span class="o">=</span> <span class="p">[</span>
            <span class="mi">12</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
            <span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>  <span class="c1"># for animation</span>


    <span class="k">def</span> <span class="nf">make_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Nx</span><span class="p">,</span> <span class="n">Ny</span><span class="p">,</span> <span class="n">kappa_values</span><span class="p">,</span> <span class="n">subdomain_corners</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize mesh, boundary parts, and p.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">UnitSquareMesh</span><span class="p">(</span><span class="n">Nx</span><span class="p">,</span> <span class="n">Ny</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">divisions</span> <span class="o">=</span> <span class="p">(</span><span class="n">Nx</span><span class="p">,</span> <span class="n">Ny</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">boundary_parts</span> <span class="o">=</span> \
             <span class="n">mark_boundaries_in_hypercube</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="o">=</span>  <span class="n">Measure</span><span class="p">(</span>
            <span class="s1">&#39;ds&#39;</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
            <span class="n">subdomain_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_parts</span><span class="p">)</span>

        <span class="c1"># The domain is the unit square with an embedded rectangle</span>
        <span class="k">class</span> <span class="nc">Rectangle</span><span class="p">(</span><span class="n">SubDomain</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomain_def</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">subdomain_def</span> <span class="o">=</span> <span class="n">subdomain_def</span>
                <span class="n">SubDomain</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">inside</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">on_boundary</span><span class="p">):</span>
                <span class="c1"># subdomain_def:</span>
                <span class="c1"># 0.3 &lt;= x[0] &lt;= 0.7 &amp;&amp; 0.5 &lt;= x[1] &lt;= 0.9</span>
                <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subdomain_def</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">materials</span> <span class="o">=</span> <span class="n">CellFunction</span><span class="p">(</span><span class="s1">&#39;size_t&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">materials</span><span class="o">.</span><span class="n">set_all</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># &quot;the rest&quot;</span>
        <span class="c1"># Give subdomain_corners as (c,c),(b,b)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">subdomain_corners</span>
        <span class="n">subdomain_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%g</span><span class="s1"> &lt;= x[0] &lt;= </span><span class="si">%g</span><span class="s1"> and </span><span class="si">%g</span><span class="s1"> &lt;= x[1] &lt;= </span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> \
                        <span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1">#subdomain = CompiledSubDomain(subdomain_str.replace(&#39;and&#39;, &#39;&amp;&amp;&#39;))</span>
        <span class="n">subdomain</span> <span class="o">=</span> <span class="n">Rectangle</span><span class="p">(</span><span class="n">subdomain_str</span><span class="p">)</span>
        <span class="n">subdomain</span><span class="o">.</span><span class="n">mark</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">materials</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">V0</span> <span class="o">=</span> <span class="n">FunctionSpace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="s1">&#39;DG&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kappa</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V0</span><span class="p">)</span>
        <span class="n">help</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">materials</span><span class="o">.</span><span class="n">array</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kappa</span><span class="o">.</span><span class="n">vector</span><span class="p">()[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">help</span><span class="p">,</span> <span class="n">kappa_values</span><span class="p">)</span>
        <span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">materials</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Subdomain&#39;</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">time_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mf">0.04</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0005</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.025</span>

    <span class="k">def</span> <span class="nf">end_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mf">0.5</span>

    <span class="k">def</span> <span class="nf">heat_conduction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">kappa</span>

    <span class="k">def</span> <span class="nf">Dirichlet_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return list of (value,boundary) pairs.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[(</span><span class="mf">1.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_parts</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<div class="section" id="results-2">
<h4>Results<a class="headerlink" href="#results-2" title="Permalink to this headline">¶</a></h4>
<p>We run a case where <span class="math">\(\alpha=1000\)</span>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">demo_Problem2</span><span class="p">():</span>
    <span class="n">problem</span> <span class="o">=</span> <span class="n">Problem2</span><span class="p">(</span><span class="n">Nx</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">Ny</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">kappa_values</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1000</span><span class="p">],</span>
              <span class="n">subdomain_corners</span><span class="o">=</span><span class="p">[(</span><span class="mf">0.3</span><span class="p">,</span><span class="mf">0.3</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.7</span><span class="p">,</span><span class="mf">0.7</span><span class="p">)])</span>
    <span class="n">problem</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">theta</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linear_solver</span><span class="o">=</span><span class="s1">&#39;direct&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;tmp1.png&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;tmp1.pdf&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>As shown in Figure <a class="reference internal" href="#ch-diffusion-refactor-class-solver-fig2"><span class="std std-ref">Development of thermal boundary layer in heterogeneous medium</span></a>,
the highly conductive inner material leads to a flat temperature profile
in this region. The start of the process is as before, but
with an insulated boundary at <span class="math">\(x=1\)</span>, heat builds up with time.
The limiting steady state is <span class="math">\(u=1\)</span> as <span class="math">\(t\rightarrow\infty\)</span>.</p>
<div class="figure" id="id9">
<span id="ch-diffusion-refactor-class-solver-fig2"></span><a class="reference internal image-reference" href="_images/thermal_layer2_CN20.png"><img alt="_images/thermal_layer2_CN20.png" src="_images/thermal_layer2_CN20.png" style="width: 500px;" /></a>
<p class="caption"><span class="caption-text"><em>Development of thermal boundary layer in heterogeneous medium</em></span></p>
</div>
<div>
<video  loop controls width='640' height='365' preload='none'>
    <source src="_static/mov/thermal_layer2/movie.mp4"  type='video/mp4;  codecs="avc1.42E01E, mp4a.40.2"'>
    <source src="_static/mov/thermal_layer2/movie.webm" type='video/webm; codecs="vp8, vorbis"'>
    <source src="_static/mov/thermal_layer2/movie.ogg"  type='video/ogg;  codecs="theora, vorbis"'>
</video>
</div>
<p><em>Developing thermal boundary layer in heterogeneous medium (notice the jump in speed, i.e., time step!)</em></p>

<!-- Issue warning if in a Safari browser -->
<script language="javascript">
if (!!(window.safari)) {
  document.write("<div style=\"width: 95%%; padding: 10px; border: 1px solid #100; border-radius: 4px;\"><p><font color=\"red\">The above movie will not play in Safari - use Chrome, Firefox, or Opera.</font></p></div>")}
</script></div>
</div>
<div class="section" id="oscillating-boundary-temperature">
<h3>Oscillating boundary temperature<a class="headerlink" href="#oscillating-boundary-temperature" title="Permalink to this headline">¶</a></h3>
<p>The next example concerns the question: How is the temperature in the
ground affected by day and night variations at the earth&#8217;s surface?
We consider a rectangular domain with an embedded subdomain as in the
previous example. At the side <span class="math">\(y=1\)</span> (representing the earth&#8217;s
surface), we have an oscillating temperature:</p>
<div class="math">
\[u_B(t) = U_s + A\sin(w t),\]</div>
<p>where <span class="math">\(U_s\)</span> is the mean temperature, <span class="math">\([-A,A]\)</span> is the temperature variation,
and <span class="math">\(w\)</span> is the frequency, here equal to <span class="math">\(w=2\pi/P\)</span>, where <span class="math">\(P\)</span> is the
period of 24 h.</p>
<p>At the other boundaries we assume symmetry or &#8220;no change&#8221;, which implies
<span class="math">\(\partial u/\partial n = 0\)</span>. The initial condition is taken as
<span class="math">\(u=U_s\)</span>, but any value will be lost in long time simulations as a
steady state oscillatory condition is established.
Figure <a class="reference internal" href="#ch-diffusion-refactor-class-solver-fig6"><span class="std std-ref">Domain with oscillating temperature at the boundary: unscaled (left) and scaled (left)</span></a> shows the domain and
boundary conditions.</p>
<div class="figure" id="id10">
<span id="ch-diffusion-refactor-class-solver-fig6"></span><a class="reference internal image-reference" href="_images/thermal_layer3_scaling_sketch.png"><img alt="_images/thermal_layer3_scaling_sketch.png" src="_images/thermal_layer3_scaling_sketch.png" style="width: 800px;" /></a>
<p class="caption"><span class="caption-text"><em>Domain with oscillating temperature at the boundary: unscaled (left) and scaled (left)</em></span></p>
</div>
<div class="section" id="scaling">
<h4>Scaling<a class="headerlink" href="#scaling" title="Permalink to this headline">¶</a></h4>
<p>Now we expect <span class="math">\(u\)</span> to oscillate around <span class="math">\(U_s\)</span> with amplitude <span class="math">\(A\)</span>, so to
have <span class="math">\(\bar u\in [-1,1]\)</span>, we set</p>
<div class="math">
\[\bar u = \frac{u-U_s}{A}{\thinspace .}\]</div>
<p>The scaled boundary condition is then</p>
<div class="math">
\[\bar u_B(\bar t) = \sin(wt_c\bar t){\thinspace .}\]</div>
<p>We use a time scale based on <span class="math">\(w\)</span>, i.e., <span class="math">\(t_c=1/w\)</span>.
Chapter 3.2.4 in <a class="reference internal" href="._ftut2008.html#ref2" id="id5">[Ref2]</a> (see <a class="reference external" href="http://hplgit.github.io/scaling-book/doc/pub/book/html/._scaling-book008.html#___sec142">ebook</a>)
has an in-depth
coverage of the scaling of this problem. The challenge is that
the temperature will oscillate close to <span class="math">\(y=1\)</span>, but the oscillations
will decay as we move downwards. One can for special set of parameters
get very thin oscillating boundary layers, which make great demands to
the numerical methods, or one may not achieve substantial decay
so the boundary condition on <span class="math">\(y=0\)</span> becomes wrong. To zoom in on the
solution in the right way,
it turns out that the right spatial length scale is
<span class="math">\(\sqrt{2\kappa/(wc\varrho)}\)</span>. With this length scale, a typical
length of the domain in <span class="math">\(y\)</span> direction is 4.
The most appealing time scale is <span class="math">\(t_c=2/w\)</span>.</p>
<p>We end up with the same scaled problem as in the previous section,
except that at <span class="math">\(y=1\)</span> we have</p>
<div class="math">
\[\bar u_B(\bar t) = \sin(2\bar t){\thinspace .}\]</div>
</div>
<div class="section" id="the-problem-class-2">
<h4>The problem class<a class="headerlink" href="#the-problem-class-2" title="Permalink to this headline">¶</a></h4>
<p>We need a different reasoning about the time steps size since this is an
oscillatory problem. We also need to stretch the unit square so it becomes
<span class="math">\([0,4]\times [0,4]\)</span> as desired. In addition, we need to change the Dirichlet
condition. And finally, we need to adjust the curve plotting
as it now takes place in <span class="math">\(y\)</span> direction, and the axes are different.
Much of class <code class="docutils literal"><span class="pre">Problem2</span></code> can be reused, so it makes sense to make
a subclass and override the methods that do not fit.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Problem3</span><span class="p">(</span><span class="n">Problem2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Oscillating surface temperature.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Nx</span><span class="p">,</span> <span class="n">Ny</span><span class="p">,</span> <span class="n">kappa_values</span><span class="p">,</span> <span class="n">subdomain_corners</span><span class="p">):</span>
        <span class="c1"># Oscillating temperature at x=0:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surface_temp</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="mf">2.0</span>
        <span class="n">period</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">w</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">period</span><span class="o">/</span><span class="mi">30</span>  <span class="c1"># need this before Problem2.__init__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">period</span>

        <span class="n">Problem2</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">Nx</span><span class="p">,</span> <span class="n">Ny</span><span class="p">,</span> <span class="n">kappa_values</span><span class="p">,</span> <span class="n">subdomain_corners</span><span class="p">)</span>
        <span class="c1"># Stretch the mesh in y direction so we get [0,4]x[0,4]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">coordinates</span><span class="p">()[:]</span> <span class="o">*=</span> <span class="mi">4</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">user_action_object</span> <span class="o">=</span> \
                   <span class="n">ProcessSolution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u_min</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">u_max</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Compare u(x,t) as curve plots for the following times</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">times4curveplots</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">period</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="n">period</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">period</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">period</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">time_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span>

    <span class="k">def</span> <span class="nf">end_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span>

    <span class="k">def</span> <span class="nf">Dirichlet_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return list of (value,boundary) pairs.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">surface_temp</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_parts</span><span class="p">,</span> <span class="mi">3</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">user_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">timestep</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Post process solution u at time t.&quot;&quot;&quot;</span>
        <span class="n">tol</span> <span class="o">=</span> <span class="mf">1E-14</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_action_object</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">timestep</span><span class="p">)</span>
        <span class="c1"># Also plot u along line x=2</span>
        <span class="n">y_coor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">tol</span><span class="p">,</span> <span class="mi">4</span><span class="o">-</span><span class="n">tol</span><span class="p">,</span> <span class="mi">101</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">2</span><span class="p">,</span> <span class="n">y_</span><span class="p">)</span> <span class="k">for</span> <span class="n">y_</span> <span class="ow">in</span> <span class="n">y_coor</span><span class="p">]</span>
        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">()</span>
        <span class="n">u_line</span> <span class="o">=</span> <span class="p">[</span><span class="n">u</span><span class="p">(</span><span class="n">y_</span><span class="p">)</span> <span class="k">for</span> <span class="n">y_</span> <span class="ow">in</span> <span class="n">y</span><span class="p">]</span>
        <span class="c1"># Animation in figure(1)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">timestep</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y_coor</span><span class="p">,</span> <span class="n">u_line</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;u, t=</span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">t</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Solution along x=2, time step: </span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.2</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;tmp_</span><span class="si">%04d</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="n">timestep</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">u_line</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Solution along x=2, time step: </span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;tmp_</span><span class="si">%04d</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="n">timestep</span><span class="p">)</span>

        <span class="c1"># Accumulated selected curves in one plot in figure(2)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">times4curveplots</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y_coor</span><span class="p">,</span> <span class="n">u_line</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;u, t=</span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">t</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.2</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">hold</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The problem is solved by</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">demo_Problem3</span><span class="p">():</span>
    <span class="n">problem</span> <span class="o">=</span> <span class="n">Problem3</span><span class="p">(</span><span class="n">Nx</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">Ny</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">kappa_values</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">],</span>
              <span class="n">subdomain_corners</span><span class="o">=</span><span class="p">[(</span><span class="mf">0.3</span><span class="p">,</span><span class="mf">0.4</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.7</span><span class="p">,</span><span class="mf">0.8</span><span class="p">)])</span>
    <span class="n">problem</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">theta</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linear_solver</span><span class="o">=</span><span class="s1">&#39;direct&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;tmp1.png&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;tmp1.pdf&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="results-3">
<h4>Results<a class="headerlink" href="#results-3" title="Permalink to this headline">¶</a></h4>
<p>We have made runs with a homogeneous medium and with a heterogeneous medium
(using <span class="math">\(\alpha=1000\)</span> as in the previous section). Animation in ParaView
meets the problem that <span class="math">\(u=\hbox{const}\)</span> initially so we must manually set a
range for the data. Bring up the Color Map Editor (click on <strong>Edit</strong> in
the <em>Coloring</em> section in the left part of the GUI), click on the second
icon from the top, to &#8220;rescale the custom range&#8221;, give -1 and 1
as the data range, and click <strong>Update</strong> to bring this range into action.</p>
<div class="figure" id="id11">
<span id="ch-diffusion-refactor-class-solver-fig3"></span><a class="reference internal image-reference" href="_images/thermal_layer4.png"><img alt="_images/thermal_layer4.png" src="_images/thermal_layer4.png" style="width: 800px;" /></a>
<p class="caption"><span class="caption-text"><em>Oscillating boundary temperature: homogeneous (left) and heterogeneous (right) medium</em></span></p>
</div>
<div>
<video  loop controls width='640' height='365' preload='none'>
    <source src="_static/mov/thermal_layer3/movie.mp4"  type='video/mp4;  codecs="avc1.42E01E, mp4a.40.2"'>
    <source src="_static/mov/thermal_layer3/movie.webm" type='video/webm; codecs="vp8, vorbis"'>
    <source src="_static/mov/thermal_layer3/movie.ogg"  type='video/ogg;  codecs="theora, vorbis"'>
</video>
</div>
<p><em>Oscillating boundary temperature and homogeneous medium.</em></p>

<!-- Issue warning if in a Safari browser -->
<script language="javascript">
if (!!(window.safari)) {
  document.write("<div style=\"width: 95%%; padding: 10px; border: 1px solid #100; border-radius: 4px;\"><p><font color=\"red\">The above movie will not play in Safari - use Chrome, Firefox, or Opera.</font></p></div>")}
</script><div>
<video  loop controls width='640' height='365' preload='none'>
    <source src="_static/mov/thermal_layer4/movie.mp4"  type='video/mp4;  codecs="avc1.42E01E, mp4a.40.2"'>
    <source src="_static/mov/thermal_layer4/movie.webm" type='video/webm; codecs="vp8, vorbis"'>
    <source src="_static/mov/thermal_layer4/movie.ogg"  type='video/ogg;  codecs="theora, vorbis"'>
</video>
</div>
<p><em>Oscillating boundary temperature and heterogeneous medium.</em></p>

<!-- Issue warning if in a Safari browser -->
<script language="javascript">
if (!!(window.safari)) {
  document.write("<div style=\"width: 95%%; padding: 10px; border: 1px solid #100; border-radius: 4px;\"><p><font color=\"red\">The above movie will not play in Safari - use Chrome, Firefox, or Opera.</font></p></div>")}
</script><div>
<video  loop controls width='640' height='365' preload='none'>
    <source src="_static/mov/thermal_layer3/paraview.ogg"  type='video/ogg;  codecs="theora, vorbis"'>
</video>
</div>
<p><em>Scalar field animation (homogeneous medium).</em></p>

<!-- Issue warning if in a Safari browser -->
<script language="javascript">
if (!!(window.safari)) {
  document.write("<div style=\"width: 95%%; padding: 10px; border: 1px solid #100; border-radius: 4px;\"><p><font color=\"red\">The above movie will not play in Safari - use Chrome, Firefox, or Opera.</font></p></div>")}
</script><div class="admonition-tip-let-related-problem-classes-utilize-inheritance admonition">
<p class="first admonition-title">Tip: Let related problem classes utilize inheritance</p>
<p class="last">The last three examples regard quite related problems, yet they have
substantial differences. The typical approach to making FEniCS software
to these applications would be to have three flat programs, each containing
a full solver of the PDE, but with details adapted to the problem at
hand. The class approach, on the other hand,
shows how all applications share the same
numerical implementation. The different problem classes can also share
a lot of code so inheritance is a way to save writing.
However, such class programming requires some experience as it is easy
to make mistakes and inherit functionality that is wrong.</p>
</div>
</div>
</div>
<div class="section" id="exercise-2-implement-second-order-schemes-in-time">
<h3>Exercise 2: Implement second-order schemes in time<a class="headerlink" href="#exercise-2-implement-second-order-schemes-in-time" title="Permalink to this headline">¶</a></h3>
<p>A backward difference of accuracy <span class="math">\(\mathcal{O}({\Delta t}^2)\)</span> involves
three time levels:</p>
<div class="math">
\[\frac{\partial}{\partial t}u(x, y, t_{n+1}) \approx
\frac{u^{n+1} - 4u^n + u^{n-1}}{2{\Delta t}}{\thinspace .}\]</div>
<p>Make a solver based on this scheme. For the first time step, use the
two-level
Backward Euler method. The implementation should also offer the Backward Euler
method. In addition, implement the Crank-Nicolson method where you solve</p>
<div class="math">
\[\frac{\partial u}{\partial t} = G(u)\]</div>
<p>by</p>
<div class="math">
\[\frac{u^{n+1}-u^n}{{\Delta t}} = \frac{1}{2}(G(u^{n+1}) + G(u^n)){\thinspace .}\]</div>
<p>This method also has a truncation error of order <span class="math">\({\Delta t}^2\)</span>.
[<strong>hpl 8</strong>: Find some good test problems for comparing the performance of the schemes.]</p>
</div>
</div>
</div>


    </div>
  </div>
</div>
<footer id="footer">
  <div class="container">
      <div class="row">
          <div class="col-sm-12 text-center bottom-separator">
          </div>
          <div class="col-md-3 col-sm-6 col-xs-12">
              <h2 class="menu_head">Usage Documentation</h2>
              <div class="footer_menu">
                  <ul>
                    <li><a href="http://hplgit.github.io/fenics-tutorial/doc/web/index.html">Tutorial</a></li>
                    <li><a href="http://fenicsproject.org/documentation/dolfin/dev/python/">Python API</a></li>
                    <li><a href="http://fenicsproject.org/documentation/dolfin/dev/cpp/">C++ API</a></li>
                    <li><a href="http://fenicsproject.org/releases/">Release notes</a></li>
                  </ul>
              </div>
          </div>
          <div class="col-md-3 col-sm-6 col-xs-12">
              <h2 class="menu_head">Developer Resources</h2>
              <div class="footer_menu">
                  <ul>
                    <li><a href="http://fenicsproject.org/buildbot/">Buildbot</a></li>
                    <li><a href="http://fenicsproject.org/benchbot/">Benchbot</a></li>
                    <li><a href="https://bitbucket.org/fenics-project/">FEniCS on Bitbucket</a></li>
                    <li><a href="http://fenicsproject.org/pub/">File archive</a></li>
                  </ul>
              </div>
          </div>

          <div class="col-md-6 col-sm-12 col-xs-12">
            
              
<form class="navbar-form navbar-right" action="/search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
            
          </div>

          <div class="col-sm-12" style="margin-top:20px;">
              <div class="copyright-text text-center">
                  <p>&copy; Copyright 2016, The FEniCS Project. (<a href="http://fenicsproject.org/disclaimer.html">Disclaimer</a>)</p>
              </div>
          </div>
      </div>
  </div>
</footer>

  </body>
</html>