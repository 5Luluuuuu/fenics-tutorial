<!--
Automatically generated HTML file from DocOnce source
(https://github.com/hplgit/doconce/)
-->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="DocOnce: https://github.com/hplgit/doconce/" />
<meta name="description" content="The FEniCS Tutorial - Writing State-of-the-Art Finite Element Solvers in Minutes">
<meta name="keywords" content="Poisson's equation,variational formulation,test function,trial function,abstract variational formulation,finite element specifications,CG finite element family,Lagrange finite element family,P1 element,Periodic Table of the Finite Elements,Dirichlet boundary conditions,boundary specification (function),C++ expression syntax,expression syntax (C++),boundary specification (function),UFL,degrees of freedom,degrees of freedom array,nodal values array,numbering degrees of freedom,numbering cell vertices,Expression with parameters,interpolation,visualization,plotting,VTK,rotate PDF plots,time-dependent PDEs,unit testing,linear algebra backend,PETSc,Trilinos,MTL4,uBLAS,UMFPACK,LinearVariationalProblem,LinearVariationalSolver,compute vertex values,vertex values,vertex to dof map,dof to vertex map,dimension-independent code,projection,projection,degrees of freedom array,nodal values array,degrees of freedom array (vector field),Poisson's equation with variable coefficient,linear systems (in FEniCS),assembly of linear systems,SLEPc,KrylovSolver,random start vector (linear systems),structured mesh,visualization, structured mesh,surface plot (structured mesh),contour plot,functionals,energy functional,error functional,flux functional,Neumann boundary conditions,heterogeneous media,multi-material domain,boundary specification (class),Dirichlet boundary conditions,Neumann boundary conditions,Robin boundary conditions,boundary conditions,Robin condition">

<title>The FEniCS Tutorial - Writing State-of-the-Art Finite Element Solvers in Minutes</title>

<!-- Bootstrap style: bootswatch_journal -->
<link href="http://netdna.bootstrapcdn.com/bootswatch/3.1.1/journal/bootstrap.min.css" rel="stylesheet">
<!-- not necessary
<link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
-->

<style type="text/css">
/* Let inline verbatim have the same color as the surroundings */
code { color: inherit; background-color: transparent; }

/* Add scrollbar to dropdown menus in bootstrap navigation bar */
.dropdown-menu {
   height: auto;
   max-height: 400px;
   overflow-x: hidden;
}

body { font-size:20px;line-height:1.5; }
</style>


</head>

<!-- tocinfo
{'highest level': 0,
 'sections': [(u'Preface', 0, None, '___sec0'),
              (u'Preliminaries', 0, u'ch:prelim', u'ch:prelim'),
              (u'The FEniCS Project', 1, None, '___sec2'),
              (u'What you will learn', 1, None, '___sec3'),
              (u'Working with this tutorial', 1, None, '___sec4'),
              (u'Obtaining the software', 1, None, '___sec5'),
              (u'Installation using Docker containers', 2, None, '___sec6'),
              (u'Installation using Ubuntu packages', 2, None, '___sec7'),
              (u'Testing your installation', 2, None, '___sec8'),
              (u'Obtaining the tutorial examples', 1, None, '___sec9'),
              (u'Background knowledge', 1, None, '___sec10'),
              (u'Programming in Python', 2, u'ftut:pybooks', u'ftut:pybooks'),
              (u'The finite element method',
               2,
               u'ftut:fembooks',
               u'ftut:fembooks'),
              (u'Fundamentals: Solving the Poisson equation',
               0,
               u'ch:fundamentals',
               u'ch:fundamentals'),
              (u'Mathematical problem formulation',
               1,
               u'ftut:poisson1:bvp',
               u'ftut:poisson1:bvp'),
              (u'Finite element variational formulation',
               2,
               u'ch:poisson0:varform',
               u'ch:poisson0:varform'),
              (u'Abstract finite element variational formulation',
               2,
               u'ch:poisson0:abstrat',
               u'ch:poisson0:abstrat'),
              (u'Choosing a test problem',
               2,
               u'ch:poisson0:testproblem',
               u'ch:poisson0:testproblem'),
              (u'FEniCS implementation',
               2,
               u'ch:poisson0:impl',
               u'ch:poisson0:impl'),
              (u'Running the program',
               2,
               u'ch:poisson0:impl:run',
               u'ch:poisson0:impl:run'),
              (u'Terminal window', 3, None, '___sec20'),
              (u'Spyder', 3, None, '___sec21'),
              (u'Jupyter notebooks', 3, None, '___sec22'),
              (u'Dissection of the program',
               2,
               u'ch:poisson0:impl:dissect',
               u'ch:poisson0:impl:dissect'),
              (u'The important first line', 3, None, '___sec24'),
              (u'Generating simple meshes', 3, None, '___sec25'),
              (u'Defining the finite element function space',
               3,
               None,
               '___sec26'),
              (u'Defining the trial and test functions', 3, None, '___sec27'),
              (u'Defining the boundary and the boundary conditions',
               3,
               None,
               '___sec28'),
              (u'Defining the source term', 3, None, '___sec29'),
              (u'Defining the variational problem', 3, None, '___sec30'),
              (u'Forming and solving the linear system', 3, None, '___sec31'),
              (u'Plotting the solution', 3, None, '___sec32'),
              (u'Exporting and post-processing the solution',
               3,
               None,
               '___sec33'),
              (u'Computing the error', 3, None, '___sec34'),
              (u'Degrees of freedom and vertex values',
               2,
               u'ch:poisson0:impl:dofmap',
               u'ch:poisson0:impl:dofmap'),
              (u'Deflection of a membrane',
               1,
               u'ch:poisson0:membrane',
               u'ch:poisson0:membrane'),
              (u'Scaling', 2, None, '___sec37'),
              (u'Defining the mesh', 2, None, '___sec38'),
              (u'Defining the load', 2, None, '___sec39'),
              (u'Variational form', 2, None, '___sec40'),
              (u'Visualization', 2, None, '___sec41'),
              (u'Curve plots through the domain', 2, None, '___sec42'),
              (u'Running ParaView', 2, u'ftut:paraview', u'ftut:paraview'),
              (u'Using the built-in visualization tool',
               2,
               u'ftut:quickviz',
               u'ftut:quickviz'),
              (u'Exercise 1: Visualize a solution in a cube',
               2,
               None,
               '___sec45'),
              (u'A Gallery of finite element solvers',
               0,
               u'ch:gallery',
               u'ch:gallery'),
              (u'The time-dependent diffusion equation',
               1,
               u'ch:fundamentals:diffusion',
               u'ch:fundamentals:diffusion'),
              (u'Variational formulation',
               2,
               u'ftut:timedep:diffusion1',
               u'ftut:timedep:diffusion1'),
              (u'A simple implementation',
               2,
               u'ftut:timedep:diffusion1:impl',
               u'ftut:timedep:diffusion1:impl'),
              (u'Test problem', 3, None, '___sec50'),
              (u'The code', 3, None, '___sec51'),
              (u'Diffusion of a Gaussian function', 2, None, '___sec52'),
              (u'The mathematical problem', 3, None, '___sec53'),
              (u'Implementation', 3, None, '___sec54'),
              (u'Visualization in ParaView', 3, None, '___sec55'),
              (u'A nonlinear Poisson equation', 1, None, '___sec56'),
              (u'Variational formulation', 2, None, '___sec57'),
              (u'A simple implementation',
               2,
               u'ftut:nonlinear:Newton:auto',
               u'ftut:nonlinear:Newton:auto'),
              (u'Overview', 3, None, '___sec59'),
              (u'Constructing a test problem with SymPy',
               3,
               None,
               '___sec60'),
              (u'The equations of linear elasticity',
               1,
               u'ftut:elast',
               u'ftut:elast'),
              (u'Variational formulation',
               2,
               u'ftut:elast:varform',
               u'ftut:elast:varform'),
              (u'A simple implementation', 2, None, '___sec63'),
              (u'Test problem', 3, None, '___sec64'),
              (u'Code', 3, None, '___sec65'),
              (u'The Navier--Stokes equations', 1, None, '___sec66'),
              (u'Variational formulation', 2, None, '___sec67'),
              (u'A simple implementation', 2, None, '___sec68'),
              (u'Mesh generation, subdomains and boundary conditions',
               0,
               u'ch:subdomains',
               u'ch:subdomains'),
              (u'Physical problem formulation', 1, None, '___sec70'),
              (u'Mathematical problem formulation', 1, None, '___sec71'),
              (u'Scaling the equation', 1, None, '___sec72'),
              (u'Finite element variational formulation',
               1,
               None,
               '___sec73'),
              (u'Mesh generation', 1, None, '___sec74'),
              (u'Subdomain markers', 1, None, '___sec75'),
              (u'The complete program', 1, None, '___sec76'),
              (u'Python programming and PDE solver design',
               0,
               u'ch:poisson',
               u'ch:poisson'),
              (u'Refactored implementation',
               1,
               u'ch:poisson0:impl2',
               u'ch:poisson0:impl2'),
              (u'A general solver function', 2, None, '___sec79'),
              (u'Plotting for the test problem', 3, None, '___sec80'),
              (u'Make a module!', 3, None, '___sec81'),
              (u'Verification and unit tests', 2, None, '___sec82'),
              (u'Exercise 2: Solve a Poisson problem', 2, None, '___sec83'),
              (u'Remarks', 3, None, '___sec84'),
              (u'Exercise 3: Refactor the code for membrane deflection',
               2,
               u'ch:poisson0:exer:membrane',
               u'ch:poisson0:exer:membrane'),
              (u'Useful extensions', 1, None, '___sec86'),
              (u'Controlling the solution process',
               2,
               u'ch:poisson0:solve:prm',
               u'ch:poisson0:solve:prm'),
              (u'Setting linear solver parameters', 3, None, '___sec88'),
              (u'Linear algebra backend', 3, None, '___sec89'),
              (u'The `parameters` database', 3, None, '___sec90'),
              (u'An extended solver function', 3, None, '___sec91'),
              (u'Remark regarding unit tests', 3, None, '___sec92'),
              (u'Linear solvers and preconditioners',
               2,
               u'ftut:app:solver:prec',
               u'ftut:app:solver:prec'),
              (u'Linear variational problem and solver objects',
               2,
               u'ch:poisson0:solver:problem',
               u'ch:poisson0:solver:problem'),
              (u'Writing out the discrete solution',
               2,
               u'ch:poisson0:verify1',
               u'ch:poisson0:verify1'),
              (u'Parameterizing the number of space dimensions',
               2,
               u'ch:poisson0:nD',
               u'ch:poisson0:nD'),
              (u'Generating a hypercube', 3, None, '___sec97'),
              (u'Computing derivatives',
               2,
               u'ch:poisson0:gradu',
               u'ch:poisson0:gradu'),
              (u'A variable-coefficient Poisson problem',
               2,
               u'ftut:possion:2D:varcoeff',
               u'ftut:possion:2D:varcoeff'),
              (u'Test problem', 3, None, '___sec100'),
              (u'Modifications of the PDE solver', 3, None, '___sec101'),
              (u'Modifications of the flux computations',
               3,
               None,
               '___sec102'),
              (u'Creating the linear system explicitly',
               2,
               u'ch:poisson0:linalg',
               u'ch:poisson0:linalg'),
              (u'Taking advantage of structured mesh data',
               2,
               u'ftut:structviz',
               u'ftut:structviz'),
              (u'Iterating over points and values', 3, None, '___sec105'),
              (u'Finite difference approximations', 3, None, '___sec106'),
              (u'Surface plot', 3, None, '___sec107'),
              (u'Contour plot', 3, None, '___sec108'),
              (u'Curve plot through the mesh', 3, None, '___sec109'),
              (u'Curve plot of the flux', 3, None, '___sec110'),
              (u'Test problem', 3, None, '___sec111'),
              (u'Postprocessing computations', 1, None, '___sec112'),
              (u'Computing functionals',
               2,
               u'ch:poisson0:functionals',
               u'ch:poisson0:functionals'),
              (u'Energy functional', 3, None, '___sec114'),
              (u'Error functional', 3, None, '___sec115'),
              (u'Flux Functionals', 3, None, '___sec116'),
              (u'Computing convergence rates',
               2,
               u'ch:poisson0:convrates',
               u'ch:poisson0:convrates'),
              (u'Various ways of computing the error', 3, None, '___sec118'),
              (u'Computing convergence rates empirically',
               3,
               None,
               '___sec119'),
              (u'Test problem', 3, None, '___sec120'),
              (u'Experiments', 3, None, '___sec121'),
              (u'Multiple domains and boundaries', 1, None, '___sec122'),
              (u'Combining Dirichlet and Neumann conditions',
               2,
               u'ch:poisson0:DN',
               u'ch:poisson0:DN'),
              (u'PDE problem', 3, None, '___sec124'),
              (u'Variational formulation', 3, None, '___sec125'),
              (u'Implementation', 3, None, '___sec126'),
              (u'Multiple Dirichlet conditions',
               2,
               u'ch:poisson0:multiple:Dirichlet',
               u'ch:poisson0:multiple:Dirichlet'),
              (u'Functions for marking Dirichlet boundaries',
               3,
               None,
               '___sec128'),
              (u'Working with subdomains',
               2,
               u'ftut:possion:2D:2mat:impl',
               u'ftut:possion:2D:2mat:impl'),
              (u'Expression objects with if test', 3, None, '___sec130'),
              (u'Mesh functions', 3, None, '___sec131'),
              (u'C++ strings for subdomain definitions',
               3,
               None,
               '___sec132'),
              (u'Exercise 4: Efficiency of Python vs C++ expressions',
               2,
               u'ch:poisson0:exer:eff:expression',
               u'ch:poisson0:exer:eff:expression'),
              (u'Multiple Neumann, Robin, and Dirichlet condition',
               2,
               u'ch:poisson0:multi:bc',
               u'ch:poisson0:multi:bc'),
              (u'Three types of boundary conditions', 3, None, '___sec135'),
              (u'A general model problem', 3, None, '___sec136'),
              (u'Variational formulation', 3, None, '___sec137'),
              (u'Implementation of boundary conditions',
               3,
               None,
               '___sec138'),
              (u'Simplified handling of the variational formulation',
               3,
               None,
               '___sec139'),
              (u'Test problem', 3, None, '___sec140'),
              (u'Debugging the setting of boundary conditions',
               3,
               None,
               '___sec141'),
              (u'Implementation of multiple subdomains',
               3,
               None,
               '___sec142'),
              (u'Refactoring of a solver function into solver and problem classes',
               2,
               None,
               '___sec143'),
              (u'Bibliography', 1, None, '___sec144')]}
end of tocinfo -->

<body>



<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: {
     equationNumbers: {  autoNumber: "none"  },
     extensions: ["AMSmath.js", "AMSsymbols.js", "autobold.js", "color.js"]
  }
});
</script>
<script type="text/javascript"
 src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<!-- newcommands.tex -->
$$
\newcommand{\dt}{\Delta t}
\newcommand{\tp}{\thinspace .}
\newcommand{\uex}{{u_{\small\mbox{e}}}}
\newcommand{\normalvec}{\boldsymbol{n}}
\newcommand{\x}{\boldsymbol{x}}
\newcommand{\Vg}{V^{(\mbox{g})}} % vector space for grad(u)
\newcommand{\dx}{\, \mathrm{d}x}
\newcommand{\dr}{\, \mathrm{d}r}
\newcommand{\ds}{\, \mathrm{d}s}
\newcommand{\WmK}{\mathrm{W}\cdot\mathrm{m}^{-1}\cdot\mathrm{K}^{-1}}
$$




    
<!-- Bootstrap navigation bar -->
<div class="navbar navbar-default navbar-fixed-top">
  <div class="navbar-header">
    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-responsive-collapse">
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <a class="navbar-brand" href="ftut1.html">The FEniCS Tutorial - Writing State-of-the-Art Finite Element Solvers in Minutes</a>
  </div>

  <div class="navbar-collapse collapse navbar-responsive-collapse">
    <ul class="nav navbar-nav navbar-right">
      <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Contents <b class="caret"></b></a>
        <ul class="dropdown-menu">
     <!-- navigation toc: --> <li><a href="._ftut1002.html#___sec0" style="font-size: 80%;"><b>Preface</b></a></li>
     <!-- navigation toc: --> <li><a href="._ftut1002.html#ch:prelim" style="font-size: 80%;"><b>Preliminaries</b></a></li>
     <!-- navigation toc: --> <li><a href="._ftut1002.html#___sec2" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;The FEniCS Project</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1002.html#___sec3" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;What you will learn</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1002.html#___sec4" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;Working with this tutorial</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1002.html#___sec5" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;Obtaining the software</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1002.html#___sec6" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Installation using Docker containers</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1002.html#___sec7" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Installation using Ubuntu packages</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1002.html#___sec8" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Testing your installation</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1002.html#___sec9" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;Obtaining the tutorial examples</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1002.html#___sec10" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;Background knowledge</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1002.html#ftut:pybooks" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Programming in Python</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1002.html#ftut:fembooks" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The finite element method</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1004.html#ch:fundamentals" style="font-size: 80%;"><b>Fundamentals: Solving the Poisson equation</b></a></li>
     <!-- navigation toc: --> <li><a href="._ftut1004.html#ftut:poisson1:bvp" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;Mathematical problem formulation</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1004.html#ch:poisson0:varform" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Finite element variational formulation</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1004.html#ch:poisson0:abstrat" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Abstract finite element variational formulation</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1005.html#ch:poisson0:testproblem" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Choosing a test problem</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1006.html#ch:poisson0:impl" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FEniCS implementation</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1006.html#ch:poisson0:impl:run" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Running the program</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1006.html#___sec20" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Terminal window</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1006.html#___sec21" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Spyder</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1006.html#___sec22" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Jupyter notebooks</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1006.html#ch:poisson0:impl:dissect" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Dissection of the program</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1006.html#___sec24" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The important first line</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1006.html#___sec25" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Generating simple meshes</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1006.html#___sec26" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Defining the finite element function space</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1006.html#___sec27" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Defining the trial and test functions</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1006.html#___sec28" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Defining the boundary and the boundary conditions</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1006.html#___sec29" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Defining the source term</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1006.html#___sec30" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Defining the variational problem</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1006.html#___sec31" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Forming and solving the linear system</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1006.html#___sec32" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Plotting the solution</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1006.html#___sec33" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Exporting and post-processing the solution</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1006.html#___sec34" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Computing the error</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1006.html#ch:poisson0:impl:dofmap" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Degrees of freedom and vertex values</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1006.html#ch:poisson0:membrane" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;Deflection of a membrane</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1006.html#___sec37" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Scaling</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1006.html#___sec38" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Defining the mesh</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1006.html#___sec39" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Defining the load</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1006.html#___sec40" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Variational form</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1006.html#___sec41" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Visualization</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1006.html#___sec42" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Curve plots through the domain</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1006.html#ftut:paraview" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Running ParaView</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1006.html#ftut:quickviz" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Using the built-in visualization tool</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1006.html#___sec45" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Exercise 1: Visualize a solution in a cube</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1008.html#ch:gallery" style="font-size: 80%;"><b>A Gallery of finite element solvers</b></a></li>
     <!-- navigation toc: --> <li><a href="._ftut1008.html#ch:fundamentals:diffusion" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;The time-dependent diffusion equation</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1008.html#ftut:timedep:diffusion1" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Variational formulation</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1008.html#ftut:timedep:diffusion1:impl" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A simple implementation</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1008.html#___sec50" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Test problem</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1008.html#___sec51" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The code</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1008.html#___sec52" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Diffusion of a Gaussian function</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1008.html#___sec53" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The mathematical problem</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1008.html#___sec54" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Implementation</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1008.html#___sec55" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Visualization in ParaView</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1008.html#___sec56" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;A nonlinear Poisson equation</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1008.html#___sec57" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Variational formulation</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1008.html#ftut:nonlinear:Newton:auto" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A simple implementation</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1008.html#___sec59" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Overview</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1008.html#___sec60" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Constructing a test problem with SymPy</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1008.html#ftut:elast" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;The equations of linear elasticity</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1008.html#ftut:elast:varform" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Variational formulation</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1008.html#___sec63" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A simple implementation</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1008.html#___sec64" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Test problem</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1008.html#___sec65" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Code</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1008.html#___sec66" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;The Navier--Stokes equations</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1008.html#___sec67" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Variational formulation</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1008.html#___sec68" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A simple implementation</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1010.html#ch:subdomains" style="font-size: 80%;"><b>Mesh generation, subdomains and boundary conditions</b></a></li>
     <!-- navigation toc: --> <li><a href="._ftut1010.html#___sec70" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;Physical problem formulation</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1010.html#___sec71" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;Mathematical problem formulation</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1010.html#___sec72" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;Scaling the equation</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1010.html#___sec73" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;Finite element variational formulation</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1010.html#___sec74" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;Mesh generation</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1010.html#___sec75" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;Subdomain markers</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1010.html#___sec76" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;The complete program</a></li>
     <!-- navigation toc: --> <li><a href="#ch:poisson" style="font-size: 80%;"><b>Python programming and PDE solver design</b></a></li>
     <!-- navigation toc: --> <li><a href="#ch:poisson0:impl2" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;Refactored implementation</a></li>
     <!-- navigation toc: --> <li><a href="#___sec79" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A general solver function</a></li>
     <!-- navigation toc: --> <li><a href="#___sec80" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Plotting for the test problem</a></li>
     <!-- navigation toc: --> <li><a href="#___sec81" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Make a module!</a></li>
     <!-- navigation toc: --> <li><a href="#___sec82" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Verification and unit tests</a></li>
     <!-- navigation toc: --> <li><a href="#___sec83" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Exercise 2: Solve a Poisson problem</a></li>
     <!-- navigation toc: --> <li><a href="#___sec84" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Remarks</a></li>
     <!-- navigation toc: --> <li><a href="#ch:poisson0:exer:membrane" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Exercise 3: Refactor the code for membrane deflection</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1012.html#___sec86" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;Useful extensions</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1012.html#ch:poisson0:solve:prm" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Controlling the solution process</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1012.html#___sec88" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Setting linear solver parameters</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1012.html#___sec89" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Linear algebra backend</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1012.html#___sec90" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The <code>parameters</code> database</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1012.html#___sec91" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;An extended solver function</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1012.html#___sec92" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Remark regarding unit tests</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1012.html#ftut:app:solver:prec" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Linear solvers and preconditioners</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1012.html#ch:poisson0:solver:problem" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Linear variational problem and solver objects</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1012.html#ch:poisson0:verify1" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Writing out the discrete solution</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1012.html#ch:poisson0:nD" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Parameterizing the number of space dimensions</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1012.html#___sec97" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Generating a hypercube</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1012.html#ch:poisson0:gradu" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Computing derivatives</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1012.html#ftut:possion:2D:varcoeff" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A variable-coefficient Poisson problem</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1012.html#___sec100" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Test problem</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1012.html#___sec101" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Modifications of the PDE solver</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1012.html#___sec102" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Modifications of the flux computations</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1012.html#ch:poisson0:linalg" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Creating the linear system explicitly</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1012.html#ftut:structviz" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Taking advantage of structured mesh data</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1012.html#___sec105" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Iterating over points and values</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1012.html#___sec106" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Finite difference approximations</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1012.html#___sec107" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Surface plot</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1012.html#___sec108" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Contour plot</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1012.html#___sec109" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Curve plot through the mesh</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1012.html#___sec110" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Curve plot of the flux</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1012.html#___sec111" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Test problem</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1013.html#___sec112" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;Postprocessing computations</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1013.html#ch:poisson0:functionals" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Computing functionals</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1013.html#___sec114" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Energy functional</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1013.html#___sec115" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Error functional</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1013.html#___sec116" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Flux Functionals</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1013.html#ch:poisson0:convrates" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Computing convergence rates</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1013.html#___sec118" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Various ways of computing the error</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1013.html#___sec119" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Computing convergence rates empirically</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1013.html#___sec120" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Test problem</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1013.html#___sec121" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Experiments</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1014.html#___sec122" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;Multiple domains and boundaries</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1014.html#ch:poisson0:DN" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Combining Dirichlet and Neumann conditions</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1014.html#___sec124" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PDE problem</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1014.html#___sec125" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Variational formulation</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1014.html#___sec126" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Implementation</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1014.html#ch:poisson0:multiple:Dirichlet" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Multiple Dirichlet conditions</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1014.html#___sec128" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Functions for marking Dirichlet boundaries</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1014.html#ftut:possion:2D:2mat:impl" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Working with subdomains</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1014.html#___sec130" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Expression objects with if test</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1014.html#___sec131" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Mesh functions</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1014.html#___sec132" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C++ strings for subdomain definitions</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1014.html#ch:poisson0:exer:eff:expression" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Exercise 4: Efficiency of Python vs C++ expressions</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1014.html#ch:poisson0:multi:bc" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Multiple Neumann, Robin, and Dirichlet condition</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1014.html#___sec135" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Three types of boundary conditions</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1014.html#___sec136" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A general model problem</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1014.html#___sec137" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Variational formulation</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1014.html#___sec138" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Implementation of boundary conditions</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1014.html#___sec139" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Simplified handling of the variational formulation</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1014.html#___sec140" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Test problem</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1014.html#___sec141" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Debugging the setting of boundary conditions</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1014.html#___sec142" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Implementation of multiple subdomains</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1014.html#___sec143" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Refactoring of a solver function into solver and problem classes</a></li>
     <!-- navigation toc: --> <li><a href="._ftut1015.html#___sec144" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;Bibliography</a></li>

        </ul>
      </li>
    </ul>
  </div>
</div>
</div> <!-- end of navigation bar -->

<div class="container">

<p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p> <!-- add vertical space -->

<a name="part0011"></a>
<!-- !split -->

<center><h1 id="ch:poisson">Python programming and PDE solver design</h1></center> <!-- chapter heading -->

<p>

<!-- begin inline comment -->
<font color="red">(<b>hpl 9</b>: I don't like this title, but have no other good alternative...)</font>
<!-- end inline comment -->


<!-- begin inline comment -->
<font color="red">(<b>AL 10</b>: Experimenting with new title)</font>
<!-- end inline comment -->

<h1 id="ch:poisson0:impl2">Refactored implementation</h1>

<p>
Our first programs in this book are all &quot;flat&quot;. That is,
they are not organized
into logical, reusable units in terms of Python functions. Such flat
programs are popular for quickly testing out some software, but not
well suited for serious problem solving. We shall therefore at once
<em>refactor</em> the program, meaning that we divide it into functions, but
this is just a reordering of the existing statements. During
refactoring, we try make functions as reusable as possible in other
contexts, but statements specific to a certain problem or task are
also encapsulated in (non-reusable) functions.  Being able to
distinguish reusable code from specialized code is a key issue when
refactoring code, and this ability depends on a good mathematical
understanding of the problem at hand (&quot;what is general, what is
special?&quot;).  In a flat program, general and specialized code (and
mathematics) is often mixed together.

<h2 id="___sec79">A general solver function </h2>

<p>
We consider the flat program developed in the section <a href="._ftut1006.html#ch:poisson0:impl">FEniCS implementation</a>.
Some of the code in this program is needed to solve any
Poisson problem \( -\nabla^2 u=f \) on \( [0,1]\times [0,1] \) with \( u=u_0 \) on
the boundary, while other statements arise from our simple test
problem. Let us collect the general, reusable code in a function
<code>solver</code>.  Our special test problem will then just be an application
of <code>solver</code> with some additional statements.  We limit the <code>solver</code>
function to just <em>compute the numerical solution</em>. Plotting and
comparing the solution with the exact solution are considered to be
problem-specific activities to be performed elsewhere.

<p>
We parameterize <code>solver</code> by \( f \), \( u_0 \), and the resolution of the
mesh. Since it is so trivial to use higher-order finite element
functions by changing the third argument to <code>FunctionSpace</code>, we let
also the degree of the polynomials in the finite element basis
functions be an argument to <code>solver</code>.

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">fenics</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #666666">*</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">solver</span>(f, u0, Nx, Ny, degree<span style="color: #666666">=1</span>):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">    Solve -Laplace(u)=f on [0,1]x[0,1] with 2*Nx*Ny Lagrange</span>
<span style="color: #BA2121; font-style: italic">    elements of specified degree and u=u0 (Expresssion) on</span>
<span style="color: #BA2121; font-style: italic">    the boundary.</span>
<span style="color: #BA2121; font-style: italic">    &quot;&quot;&quot;</span>
    <span style="color: #408080; font-style: italic"># Create mesh and define function space</span>
    mesh <span style="color: #666666">=</span> UnitSquareMesh(Nx, Ny)
    V <span style="color: #666666">=</span> FunctionSpace(mesh, <span style="color: #BA2121">&#39;P&#39;</span>, degree)

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">u0_boundary</span>(x, on_boundary):
        <span style="color: #008000; font-weight: bold">return</span> on_boundary

    bc <span style="color: #666666">=</span> DirichletBC(V, u0, u0_boundary)

    <span style="color: #408080; font-style: italic"># Define variational problem</span>
    u <span style="color: #666666">=</span> TrialFunction(V)
    v <span style="color: #666666">=</span> TestFunction(V)
    a <span style="color: #666666">=</span> dot(grad(u), grad(v))<span style="color: #666666">*</span>dx
    L <span style="color: #666666">=</span> f<span style="color: #666666">*</span>v<span style="color: #666666">*</span>dx

    <span style="color: #408080; font-style: italic"># Compute solution</span>
    u <span style="color: #666666">=</span> Function(V)
    solve(a <span style="color: #666666">==</span> L, u, bc)

    <span style="color: #008000; font-weight: bold">return</span> u
</pre></div>

<h3 id="___sec80">Plotting for the test problem </h3>

<p>
The additional tasks we did in our initial program can be placed in
other functions. For example, plotting the solution in our particular
test problem is placed in an
<code>application_test</code> function:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">application_test</span>():
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Plot the solution in the test problem.&quot;&quot;&quot;</span>
    u0 <span style="color: #666666">=</span> Expression(<span style="color: #BA2121">&#39;1 + x[0]*x[0] + 2*x[1]*x[1]&#39;</span>)
    f <span style="color: #666666">=</span> Constant(<span style="color: #666666">-6.0</span>)
    u <span style="color: #666666">=</span> solver(f, u0, <span style="color: #666666">6</span>, <span style="color: #666666">4</span>, <span style="color: #666666">1</span>)
    <span style="color: #408080; font-style: italic"># Dump solution to file in VTK format</span>
    u<span style="color: #666666">.</span>rename(<span style="color: #BA2121">&#39;u&#39;</span>, <span style="color: #BA2121">&#39;u&#39;</span>)  <span style="color: #408080; font-style: italic"># name &#39;u&#39; is used in plot</span>
    vtkfile <span style="color: #666666">=</span> File(<span style="color: #BA2121">&quot;poisson.pvd&quot;</span>)
    vtkfile <span style="color: #666666">&lt;&lt;</span> u
    <span style="color: #408080; font-style: italic"># Plot solution and mesh</span>
    plot(u)
</pre></div>

<h3 id="___sec81">Make a module! </h3>

<p>
The refactored code is put in a file <a href="https://github.com/hplgit/fenics-tutorial/blob/master/src/poisson/ft04_poisson_func.py" target="_self"><tt>ft04_poisson_func.py</tt></a>. We should make
sure that such a file can be imported (and hence reused) in other programs.
Then all statements in the main program should appear with a test
<code>if __name__ == '__main__':</code>. This test is true if the file is executed
as a program, but false if the file is imported.
If we want to run this file in the same way as we can
run <code>ft04_poisson_func.py</code>, the main program is simply a call to
<code>application_test()</code> followed by a call <code>interactive()</code> to hold the plot:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;__main__&#39;</span>:
    application_test()
    <span style="color: #408080; font-style: italic"># Hold plot</span>
    interactive()
</pre></div>

<h2 id="___sec82">Verification and unit tests </h2>

<p>
The remaining part of our first program is to compare the numerical and
the exact solution. Every time we edit the code we must rerun the test
and examine that <code>max_error</code> is sufficiently small so we know that the
code still works. To this end, we shall adopt <em>unit testing</em>, meaning
that we create a mathematical test and corresponding software that
can run all our tests automatically and check that all tests pass.
Python has several tools for unit testing. Two very popular ones are
pytest and nose. These are almost identical and very easy to use.
More classical unit testing with test classes is offered by the built-in
tool <code>unittest</code>, but here we are going to use pytest (or nose) since it demands
shorter and clearer code.

<p>
Mathematically, our unit test is that the finite element solution of
our problem when \( f=-6 \) equals the exact solution \( u=u_0=1+x^2+2y^2 \).
We have already created code that finds the maximum error in the
numerical solution. Because of rounding errors, we cannot demand this
maximum error to be zero, but we have to use a tolerance, which depends
to the number of elements and the degrees of the polynomials in the finite
element basis functions. In the section <a href="._ftut1006.html#ch:poisson0:impl:dissect">Dissection of the program</a> we
reported some experiments with the size of the maximum error. If we want
to test that <code>solver</code> works for meshes up to \( 2(20\times 20) \) elements
and cubic Lagrange elements, \( 10^{-11} \) is
an appropriate tolerance for testing that the maximum error vanishes.

<p>
Only three statements are necessary to carry out the unit test. However,
we shall embed these statements in software that the testing frameworks
pytest and nose can recognize. This means that each unit test
must be placed in a function that

<ul>
 <li> has a name starting with <code>test_</code></li>
 <li> has no arguments</li>
 <li> implements the test as <code>assert success, msg</code></li>
</ul>

Regarding the last point, <code>success</code> is a boolean expression that is <code>False</code>
if the test fails, and in that case the string <code>msg</code> is written to the
screen. When the test fails, <code>assert</code> raises an <code>AssertionError</code> exception
in Python, otherwise the statement runs silently. The <code>msg</code> string is
optional, so <code>assert success</code> is the minimal test. In our case, we
will do <code>assert max_error &lt; tol</code>, where <code>tol</code> is the tolerance (\( 10^{-11} \))
mentioned above.

<p>
A proper <em>test function</em> for implementing this unit test in the pytest
or nose testing frameworks has the following form. Note that we perform
the test for different mesh resolutions and degrees of finite elements.

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_solver</span>():
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Reproduce u=1+x^2+2y^2 to &quot;machine precision&quot;.&quot;&quot;&quot;</span>
    tol <span style="color: #666666">=</span> <span style="color: #666666">1E-11</span>  <span style="color: #408080; font-style: italic"># This problem&#39;s precision</span>
    u0 <span style="color: #666666">=</span> Expression(<span style="color: #BA2121">&#39;1 + x[0]*x[0] + 2*x[1]*x[1]&#39;</span>)
    f <span style="color: #666666">=</span> Constant(<span style="color: #666666">-6.0</span>)
    <span style="color: #008000; font-weight: bold">for</span> Nx, Ny <span style="color: #AA22FF; font-weight: bold">in</span> [(<span style="color: #666666">3</span>,<span style="color: #666666">3</span>), (<span style="color: #666666">3</span>,<span style="color: #666666">5</span>), (<span style="color: #666666">5</span>,<span style="color: #666666">3</span>), (<span style="color: #666666">20</span>,<span style="color: #666666">20</span>)]:
        <span style="color: #008000; font-weight: bold">for</span> degree <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #666666">1</span>, <span style="color: #666666">2</span>, <span style="color: #666666">3</span>:
            <span style="color: #008000; font-weight: bold">print</span>(<span style="color: #BA2121">&#39;solving on 2(</span><span style="color: #BB6688; font-weight: bold">%d</span><span style="color: #BA2121">x</span><span style="color: #BB6688; font-weight: bold">%d</span><span style="color: #BA2121">) mesh with P</span><span style="color: #BB6688; font-weight: bold">%d</span><span style="color: #BA2121"> elements&#39;</span>
                  <span style="color: #666666">%</span> (Nx, Ny, degree))
            u <span style="color: #666666">=</span> solver(f, u0, Nx, Ny, degree)
            <span style="color: #408080; font-style: italic"># Make a finite element function of the exact u0</span>
            V <span style="color: #666666">=</span> u<span style="color: #666666">.</span>function_space()
            u0_Function <span style="color: #666666">=</span> interpolate(u0, V)  <span style="color: #408080; font-style: italic"># exact solution</span>
            <span style="color: #408080; font-style: italic"># Check that dof arrays are equal</span>
            u0_array <span style="color: #666666">=</span> u0_Function<span style="color: #666666">.</span>vector()<span style="color: #666666">.</span>array()  <span style="color: #408080; font-style: italic"># dof values</span>
            max_error <span style="color: #666666">=</span> (u0_array <span style="color: #666666">-</span> u<span style="color: #666666">.</span>vector()<span style="color: #666666">.</span>array())<span style="color: #666666">.</span>max()
            msg <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;max error: </span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121"> for 2(</span><span style="color: #BB6688; font-weight: bold">%d</span><span style="color: #BA2121">x</span><span style="color: #BB6688; font-weight: bold">%d</span><span style="color: #BA2121">) mesh and degree=</span><span style="color: #BB6688; font-weight: bold">%d</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span>\ 
                  (max_error, Nx, Ny, degree)
            <span style="color: #008000; font-weight: bold">assert</span> max_error <span style="color: #666666">&lt;</span> tol, msg
</pre></div>
<p>
We can at any time run

<p>

<!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; py.test -s -v ft04_poisson_func.py
</pre></div>
<p>
and the pytest tool will run all functions <code>test_*()</code> in the file and report
how the tests go.

<p>
We shall make it a habit in this book to encapsulate numerical test
problems in unit tests as done above, and we strongly encourage the
reader to create similar unit tests whenever a FEniCS solver is
implemented. We dare to assert that this is the only serious way
do reliable computational science with FEniCS.

<p>
<div class="alert alert-block alert-success alert-text-normal"><b>Tip: Print messages in test functions.</b>
The <code>assert</code> statement runs silently when the test passes so users may
become uncertain if all the statements in a test function are really
executed. A psychological help is to print out something before <code>assert</code>
(as we do in the example above) such that it is clear that the
test really takes place.
(Note that <code>py.test</code> needs the <code>-s</code> option to show printout
from the test functions.)
</div>


<p>
The next three sections deal with some technicalities about specifying
the solution method for linear systems (so that you can solve large
problems) and examining array data from the computed solution (so that
you can check that the program is correct).  These technicalities are
scattered around in forthcoming programs. However, the impatient
reader who is more interested in seeing the previous program being
adapted to a real physical problem, and play around with some
interesting visualizations, can safely jump to the section <a href="._ftut1006.html#ch:poisson0:membrane">Deflection of a membrane</a>.  Information in the intermediate sections
can be studied on demand.

<p>
<!-- --- begin exercise --- -->

<h2 id="___sec83">Exercise 2: Solve a Poisson problem </h2>

<p>
Solve the following problem

$$
\begin{align}
\nabla^2 u &= 2e^{-2x}\sin(\pi y)((4-5\pi^2)\sin(2\pi x) - 8\pi\cos(2\pi x))
\hbox{ in }\Omega = [0,1]\times [0,1]
\tag{5.1}\\ 
u &= 0\quad\hbox{ on }\partial\Omega
\tag{5.2}
\end{align}
$$

The exact solution is given by

$$ u(x,y) = 2e^{-2x}\sin(\pi x)\sin(\pi y)\tp$$

Compute the maximum numerical approximation error in a mesh with
\( 2(N_x\times N_y) \) elements and in a mesh with double resolution:
\( 4(N_x\times N_y) \) elements. Show that the doubling the resolution
reduces the error by a factor 4 when using Lagrange elements of degree one.
Make an illustrative plot of the solution too.

<p>
<b>a)</b>
Base your implementation on editing the program
<code>ft01_poisson_flat.py</code>.

<p>
<!-- --- begin hint in exercise --- -->

<p>
<a class="glyphicon glyphicon-hand-right showdetails" data-toggle="collapse"
 data-target="#exer_2_1" style="font-size: 80%;"></a>
<b>Hint 1.</b>
<div class="collapse-group">
<p><div class="collapse" id="exer_2_1">

<p>
In the string for an <code>Expression</code> object, <code>pi</code> is the value of
\( \pi \). Also note that \( \pi^2 \) must be expressed with syntax
<code>pow(pi,2)</code> and not (the common Python syntax) <code>pi**2</code>.

<p>
FEniCS will abort with a compilation error if you type the expressions
in a wrong way syntax-wise.  Search for <em>error:</em> in the
<code>/very/long/path/compile.log</code> file mentioned in the error message to
see what the C++ compiler reported as error in the expressions.

<p>
</div></p>
</div>
</p>

<p>
<!-- --- end hint in exercise --- -->

<p>
<!-- --- begin hint in exercise --- -->

<p>
<a class="glyphicon glyphicon-hand-right showdetails" data-toggle="collapse"
 data-target="#exer_2_2" style="font-size: 80%;"></a>
<b>Hint 2.</b>
<div class="collapse-group">
<p><div class="collapse" id="exer_2_2">

<p>
The result that with P1 elements, doubling the resolution reduces the error
with a factor of four, is an
asymptotic result so it requires a sufficiently fine mesh. Here
one may start with \( N_x=N_y=20 \).

<p>
</div></p>
</div>
</p>

<p>
<!-- --- end hint in exercise --- -->
Filename: <code>poisson_fsin_flat</code>.

<p>
<!-- --- begin solution of exercise --- -->

<p>
<a class="glyphicon glyphicon-hand-right showdetails" data-toggle="collapse"
 data-target="#exer_2_3" style="font-size: 80%;"></a>
<b>Solution.</b>
<div class="collapse-group">
<p><div class="collapse" id="exer_2_3">

<p>
Looking at the <code>ft01_poisson_flat.py</code> code, we realize that
the following edits are required:

<ul>
 <li> Modify the <code>mesh</code> computation.</li>
 <li> Modify <code>u0</code> and <code>f</code>.</li>
 <li> Add expression for the exact solution.</li>
 <li> Modify the computation of the numerical error.</li>
 <li> Insert a loop to enable solving the problem twice.</li>
 <li> Put the error reduction computation and the plot statements after the loop.</li>
</ul>

Here is the modified code:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">fenics</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #666666">*</span>

Nx <span style="color: #666666">=</span> Ny <span style="color: #666666">=</span> <span style="color: #666666">20</span>
error <span style="color: #666666">=</span> []
<span style="color: #008000; font-weight: bold">for</span> i <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(<span style="color: #666666">2</span>):
    Nx <span style="color: #666666">*=</span> (i<span style="color: #666666">+1</span>)
    Ny <span style="color: #666666">*=</span> (i<span style="color: #666666">+1</span>)

    <span style="color: #408080; font-style: italic"># Create mesh and define function space</span>
    mesh <span style="color: #666666">=</span> UnitSquareMesh(Nx, Ny)
    V <span style="color: #666666">=</span> FunctionSpace(mesh, <span style="color: #BA2121">&#39;Lagrange&#39;</span>, <span style="color: #666666">1</span>)

    <span style="color: #408080; font-style: italic"># Define boundary conditions</span>
    u0 <span style="color: #666666">=</span> Constant(<span style="color: #666666">0</span>)

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">u0_boundary</span>(x, on_boundary):
        <span style="color: #008000; font-weight: bold">return</span> on_boundary

    bc <span style="color: #666666">=</span> DirichletBC(V, u0, u0_boundary)

    <span style="color: #408080; font-style: italic"># Define variational problem</span>
    u <span style="color: #666666">=</span> TrialFunction(V)
    v <span style="color: #666666">=</span> TestFunction(V)
    f <span style="color: #666666">=</span> Expression(<span style="color: #BA2121">&#39;-2*exp(-2*x[0])*sin(pi*x[1])*(&#39;</span>
                   <span style="color: #BA2121">&#39;(4-5*pow(pi,2))*sin(2*pi*x[0]) &#39;</span>
                   <span style="color: #BA2121">&#39; - 8*pi*cos(2*pi*x[0]))&#39;</span>)
    <span style="color: #408080; font-style: italic"># Note: no need for pi=DOLFIN_PI in f, pi is valid variable</span>
    a <span style="color: #666666">=</span> inner(nabla_grad(u), nabla_grad(v))<span style="color: #666666">*</span>dx
    L <span style="color: #666666">=</span> f<span style="color: #666666">*</span>v<span style="color: #666666">*</span>dx

    <span style="color: #408080; font-style: italic"># Compute solution</span>
    u <span style="color: #666666">=</span> Function(V)
    solve(a <span style="color: #666666">==</span> L, u, bc)

    u_e <span style="color: #666666">=</span> Expression(
        <span style="color: #BA2121">&#39;2*exp(-2*x[0])*sin(2*pi*x[0])*sin(pi*x[1])&#39;</span>)

    u_e_Function <span style="color: #666666">=</span> interpolate(u_e, V)         <span style="color: #408080; font-style: italic"># exact solution</span>
    u_e_array <span style="color: #666666">=</span> u_e_Function<span style="color: #666666">.</span>vector()<span style="color: #666666">.</span>array()  <span style="color: #408080; font-style: italic"># dof values</span>
    max_error <span style="color: #666666">=</span> (u_e_array <span style="color: #666666">-</span> u<span style="color: #666666">.</span>vector()<span style="color: #666666">.</span>array())<span style="color: #666666">.</span>max()
    <span style="color: #008000; font-weight: bold">print</span>(<span style="color: #BA2121">&#39;max error:&#39;</span>, max_error, <span style="color: #BA2121">&#39;</span><span style="color: #BB6688; font-weight: bold">%d</span><span style="color: #BA2121">x</span><span style="color: #BB6688; font-weight: bold">%d</span><span style="color: #BA2121"> mesh&#39;</span> <span style="color: #666666">%</span> (Nx, Ny))
    error<span style="color: #666666">.</span>append(max_error)

<span style="color: #008000; font-weight: bold">print</span>(<span style="color: #BA2121">&#39;Error reduction:&#39;</span>, error[<span style="color: #666666">1</span>]<span style="color: #666666">/</span>error[<span style="color: #666666">0</span>])

<span style="color: #408080; font-style: italic"># Plot solution and mesh</span>
plot(u)

<span style="color: #408080; font-style: italic"># Dump solution to file in VTK format</span>
<span style="color: #008000">file</span> <span style="color: #666666">=</span> File(<span style="color: #BA2121">&quot;poisson.pvd&quot;</span>)
<span style="color: #008000">file</span> <span style="color: #666666">&lt;&lt;</span> u

<span style="color: #408080; font-style: italic"># Hold plot</span>
interactive()
</pre></div>
<p>
The number \( \pi \) has the symbol <code>M_PI</code> in C and C++, but in C++
strings in <code>Expression</code> objects, the symbol <code>pi</code> can be used directly
(or one can use the less readable <code>DOLFIN_PI</code>).

<p>
<center><p><img src="fig/poisson_fsin.png" align="bottom" width=500></p></center>

<p>
</div></p>
</div>
</p>

<p>
<!-- --- end solution of exercise --- -->

<p>
<b>b)</b>
Base your implementation on a new file that imports functionality
from the module <code>ft04_poisson_func.py</code>. Embed the check of the
reduction of the numerical approximation error in a unit test.
Filename: <code>poisson_fsin_func</code>.

<p>
<!-- --- begin solution of exercise --- -->

<p>
<a class="glyphicon glyphicon-hand-right showdetails" data-toggle="collapse"
 data-target="#exer_2_4" style="font-size: 80%;"></a>
<b>Solution.</b>
<div class="collapse-group">
<p><div class="collapse" id="exer_2_4">

<p>
Solving the two problems is a matter of calling <code>solver</code> with
different sets of arguments.
To compute the numerical error,
we need code that is close to what we have in <code>test_solver</code>.

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">poisson_func</span> <span style="color: #008000; font-weight: bold">import</span> (
    solver, Expression, Constant, interpolate, File, plot,
    interactive)

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">data</span>():
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Return data for this Poisson problem.&quot;&quot;&quot;</span>
    u0 <span style="color: #666666">=</span> Constant(<span style="color: #666666">0</span>)
    u_e <span style="color: #666666">=</span> Expression(
        <span style="color: #BA2121">&#39;2*exp(-2*x[0])*sin(2*pi*x[0])*sin(pi*x[1])&#39;</span>)
    f <span style="color: #666666">=</span> Expression(<span style="color: #BA2121">&#39;-2*exp(-2*x[0])*sin(pi*x[1])*(&#39;</span>
                   <span style="color: #BA2121">&#39;(4-5*pow(pi,2))*sin(2*pi*x[0]) &#39;</span>
                   <span style="color: #BA2121">&#39; - 8*pi*cos(2*pi*x[0]))&#39;</span>)
    <span style="color: #008000; font-weight: bold">return</span> u0, f, u_e

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_solver</span>():
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Check convergence rate of solver.&quot;&quot;&quot;</span>
    u0, f, u_e <span style="color: #666666">=</span> data()
    Nx <span style="color: #666666">=</span> <span style="color: #666666">20</span>
    Ny <span style="color: #666666">=</span> Nx
    error <span style="color: #666666">=</span> []
    <span style="color: #408080; font-style: italic"># Loop over refined meshes</span>
    <span style="color: #008000; font-weight: bold">for</span> i <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(<span style="color: #666666">2</span>):
        Nx <span style="color: #666666">*=</span> i<span style="color: #666666">+1</span>
        Ny <span style="color: #666666">*=</span> i<span style="color: #666666">+1</span>
        <span style="color: #008000; font-weight: bold">print</span>(<span style="color: #BA2121">&#39;solving on 2(</span><span style="color: #BB6688; font-weight: bold">%d</span><span style="color: #BA2121">x</span><span style="color: #BB6688; font-weight: bold">%d</span><span style="color: #BA2121">) mesh&#39;</span> <span style="color: #666666">%</span> (Nx, Ny))
        u <span style="color: #666666">=</span> solver(f, u0, Nx, Ny, degree<span style="color: #666666">=1</span>)
        <span style="color: #408080; font-style: italic"># Make a finite element function of the exact u_e</span>
        V <span style="color: #666666">=</span> u<span style="color: #666666">.</span>function_space()
        u_e_array <span style="color: #666666">=</span> interpolate(u_e, V)<span style="color: #666666">.</span>vector()<span style="color: #666666">.</span>array()
        max_error <span style="color: #666666">=</span> (u_e_array <span style="color: #666666">-</span> u<span style="color: #666666">.</span>vector()<span style="color: #666666">.</span>array())<span style="color: #666666">.</span>max()  <span style="color: #408080; font-style: italic"># Linf norm</span>
        error<span style="color: #666666">.</span>append(max_error)
        <span style="color: #008000; font-weight: bold">print</span>(<span style="color: #BA2121">&#39;max error:&#39;</span>, max_error)
    <span style="color: #008000; font-weight: bold">for</span> i <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(<span style="color: #666666">1</span>, <span style="color: #008000">len</span>(error)):
        error_reduction <span style="color: #666666">=</span> error[i]<span style="color: #666666">/</span>error[i<span style="color: #666666">-1</span>]
        <span style="color: #008000; font-weight: bold">print</span>(<span style="color: #BA2121">&#39;error reduction:&#39;</span>, error_reduction)
        <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #008000">abs</span>(error_reduction <span style="color: #666666">-</span> <span style="color: #666666">0.25</span>) <span style="color: #666666">&lt;</span> <span style="color: #666666">0.1</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">application</span>():
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Plot the solution.&quot;&quot;&quot;</span>
    u0, f, u_e <span style="color: #666666">=</span> data()
    Nx <span style="color: #666666">=</span> <span style="color: #666666">40</span>
    Ny <span style="color: #666666">=</span> Nx
    u <span style="color: #666666">=</span> solver(f, u0, Nx, Ny, <span style="color: #666666">1</span>)
    <span style="color: #408080; font-style: italic"># Dump solution to file in VTK format</span>
    <span style="color: #008000">file</span> <span style="color: #666666">=</span> File(<span style="color: #BA2121">&quot;poisson.pvd&quot;</span>)
    <span style="color: #008000">file</span> <span style="color: #666666">&lt;&lt;</span> u
    <span style="color: #408080; font-style: italic"># Plot solution and mesh</span>
    plot(u)

<span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;__main__&#39;</span>:
    test_solver()
    application()
    <span style="color: #408080; font-style: italic"># Hold plot</span>
    interactive()
</pre></div>
<p>
The unit test is embedded in a proper test function <code>test_solver</code>
for the pytest or
nose testing frameworks. Visualization of the solution is encapsulated
in the <code>application</code> function. Since we need <code>u_e</code>, <code>u0</code>, and <code>f</code>
in two functions, we place the definitions in a function <code>data</code> to
avoid copies of these expressions.

<p>
</div></p>
</div>
</p>

<p>
<!-- --- end solution of exercise --- -->

<p>
<!-- Closing remarks for this Exercise -->

<h3 id="___sec84">Remarks </h3>

<p>
This exercise demonstrates that changing a flat program to solve a new
problem requires careful editing of statements scattered around in the
file, while
the solution in b), based on the <code>solver</code> function, requires <em>no modifications</em>
of the <code>ft04_poisson_func.py</code> file, just
<em>minimalistic additional new code</em> in a separate file. The Poisson solver
remains in one place (<code>ft04_poisson_func.py</code>) while in a) we got two
Poisson solvers. If you decide to switch to an iterative solution method
for linear systems, you can do so in one place in b), and all applications
can take advantage of the extension. Hopefully, with this exercise
you realize that embedding
PDE solvers in functions (or classes) makes more reusable software than
flat programs.

<p>
<!-- --- end exercise --- -->

<p>
<!-- --- begin exercise --- -->

<h2 id="ch:poisson0:exer:membrane">Exercise 3: Refactor the code for membrane deflection</h2>

<p>
The <code>ft07_flat_poisson_membrane.py</code> simulates the deflection of
a membrane. Refactor this code such that we have a <code>solver</code> function
as in the <code>ft04_poisson_func.py</code> file. Let the user have the
option to choose a direct or iterative solver for the linear system.
Also implement a unit test where you have \( p=4 \) (constant) and
use P2 and P3 elements. In this case, the exact solution is
quadratic in \( x \) and \( y \) and will be &quot;exactly&quot; reproduced by
P2 and higher-order elements.

<p>
<!-- --- begin solution of exercise --- -->

<p>
<a class="glyphicon glyphicon-hand-right showdetails" data-toggle="collapse"
 data-target="#exer_3_1" style="font-size: 80%;"></a>
<b>Solution.</b>
<div class="collapse-group">
<p><div class="collapse" id="exer_3_1">

<p>
We can use the <code>solver</code> function from <code>ft04_poisson_func.py</code>
right away. The major difference is that
the domain is now a circle and not a square. We change the <code>solver</code>
function by letting the mesh be an argument <code>mesh</code> (instead of <code>Nx</code>
and <code>Ny</code>):

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">solver</span>(
    f, u0, mesh, degree<span style="color: #666666">=1</span>,
    linear_solver<span style="color: #666666">=</span><span style="color: #BA2121">&#39;Krylov&#39;</span>, <span style="color: #408080; font-style: italic"># Alt: &#39;direct&#39;</span>
    <span style="color: #666666">...</span>):
    V <span style="color: #666666">=</span> FunctionSpace(mesh, <span style="color: #BA2121">&#39;P&#39;</span>, degree)
    <span style="color: #408080; font-style: italic"># code as before</span>
</pre></div>
<p>
The complete code becomes

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">application</span>(beta, R0, num_elements_radial_dir):
    <span style="color: #408080; font-style: italic"># Scaled pressure function</span>
    p <span style="color: #666666">=</span> Expression(
        <span style="color: #BA2121">&#39;4*exp(-pow(beta,2)*(pow(x[0], 2) + pow(x[1]-R0, 2)))&#39;</span>,
        beta<span style="color: #666666">=</span>beta, R0<span style="color: #666666">=</span>R0)

    <span style="color: #408080; font-style: italic"># Generate mesh over the unit circle</span>
    domain <span style="color: #666666">=</span> Circle(Point(<span style="color: #666666">0.0</span>, <span style="color: #666666">0.0</span>), <span style="color: #666666">1.0</span>)
    mesh <span style="color: #666666">=</span> generate_mesh(domain, num_elements_radial_dir)

    w <span style="color: #666666">=</span> solver(p, Constant(<span style="color: #666666">0</span>), mesh, degree<span style="color: #666666">=1</span>,
               linear_solver<span style="color: #666666">=</span><span style="color: #BA2121">&#39;direct&#39;</span>)
    w<span style="color: #666666">.</span>rename(<span style="color: #BA2121">&#39;w&#39;</span>, <span style="color: #BA2121">&#39;deflection&#39;</span>)  <span style="color: #408080; font-style: italic"># set name and label (description)</span>

    <span style="color: #408080; font-style: italic"># Plot scaled solution, mesh and pressure</span>
    plot(mesh, title<span style="color: #666666">=</span><span style="color: #BA2121">&#39;Mesh over scaled domain&#39;</span>)
    plot(w, title<span style="color: #666666">=</span><span style="color: #BA2121">&#39;Scaled &#39;</span> <span style="color: #666666">+</span> w<span style="color: #666666">.</span>label())
    V <span style="color: #666666">=</span> w<span style="color: #666666">.</span>function_space()
    p <span style="color: #666666">=</span> interpolate(p, V)
    p<span style="color: #666666">.</span>rename(<span style="color: #BA2121">&#39;p&#39;</span>, <span style="color: #BA2121">&#39;pressure&#39;</span>)
    plot(p, title<span style="color: #666666">=</span><span style="color: #BA2121">&#39;Scaled &#39;</span> <span style="color: #666666">+</span> p<span style="color: #666666">.</span>label())

    <span style="color: #408080; font-style: italic"># Dump p and w to file in VTK format</span>
    vtkfile1 <span style="color: #666666">=</span> File(<span style="color: #BA2121">&#39;membrane_deflection.pvd&#39;</span>)
    vtkfile1 <span style="color: #666666">&lt;&lt;</span> w
    vtkfile2 <span style="color: #666666">=</span> File(<span style="color: #BA2121">&#39;membrane_load.pvd&#39;</span>)
    vtkfile2 <span style="color: #666666">&lt;&lt;</span> p
</pre></div>
<p>
The key function to simulate membrane deflection is named <code>application</code>.

<p>
For \( p=4 \), we have \( w=1-x^2-y^2 \) as exact solution.
The unit test for P2 and P3 goes as follows:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_membrane</span>():
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Verification for constant pressure.&quot;&quot;&quot;</span>
    p <span style="color: #666666">=</span> Constant(<span style="color: #666666">4</span>)
    <span style="color: #408080; font-style: italic"># Generate mesh over the unit circle</span>
    domain <span style="color: #666666">=</span> Circle(Point(<span style="color: #666666">0.0</span>, <span style="color: #666666">0.0</span>), <span style="color: #666666">1.0</span>)
    <span style="color: #008000; font-weight: bold">for</span> degree <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #666666">2</span>, <span style="color: #666666">3</span>:
        <span style="color: #008000; font-weight: bold">print</span>(<span style="color: #BA2121">&#39;********* P</span><span style="color: #BB6688; font-weight: bold">%d</span><span style="color: #BA2121"> elements:&#39;</span> <span style="color: #666666">%</span> degree)
        n <span style="color: #666666">=</span> <span style="color: #666666">5</span>
        <span style="color: #008000; font-weight: bold">for</span> i <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(<span style="color: #666666">4</span>):  <span style="color: #408080; font-style: italic"># Run some resolutions</span>
            n <span style="color: #666666">*=</span> (i<span style="color: #666666">+1</span>)
            mesh <span style="color: #666666">=</span> generate_mesh(domain, n)
            <span style="color: #408080; font-style: italic">#info(mesh)</span>
            w <span style="color: #666666">=</span> solver(p, Constant(<span style="color: #666666">0</span>), mesh, degree<span style="color: #666666">=</span>degree,
                       linear_solver<span style="color: #666666">=</span><span style="color: #BA2121">&#39;direct&#39;</span>)
            <span style="color: #008000; font-weight: bold">print</span>(<span style="color: #BA2121">&#39;max w: </span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">, w(0,0)=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">, h=</span><span style="color: #BB6688; font-weight: bold">%.3E</span><span style="color: #BA2121">, dofs=</span><span style="color: #BB6688; font-weight: bold">%d</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span>
                  (w<span style="color: #666666">.</span>vector()<span style="color: #666666">.</span>array()<span style="color: #666666">.</span>max(), w((<span style="color: #666666">0</span>,<span style="color: #666666">0</span>)),
                   <span style="color: #666666">1/</span>np<span style="color: #666666">.</span>sqrt(mesh<span style="color: #666666">.</span>num_vertices()),
                   w<span style="color: #666666">.</span>function_space()<span style="color: #666666">.</span>dim()))

            w_exact <span style="color: #666666">=</span> Expression(<span style="color: #BA2121">&#39;1 - x[0]*x[0] - x[1]*x[1]&#39;</span>)
            w_e <span style="color: #666666">=</span> interpolate(w_exact, w<span style="color: #666666">.</span>function_space())
            error <span style="color: #666666">=</span> np<span style="color: #666666">.</span>abs(w_e<span style="color: #666666">.</span>vector()<span style="color: #666666">.</span>array() <span style="color: #666666">-</span>
                           w<span style="color: #666666">.</span>vector()<span style="color: #666666">.</span>array())<span style="color: #666666">.</span>max()
            <span style="color: #008000; font-weight: bold">print</span>(<span style="color: #BA2121">&#39;error: </span><span style="color: #BB6688; font-weight: bold">%.3E</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> error)
            <span style="color: #008000; font-weight: bold">assert</span> error <span style="color: #666666">&lt;</span> <span style="color: #666666">9.61E-03</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">application2</span>(
    beta, R0, num_elements_radial_dir):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Explore more built-in visulization features.&quot;&quot;&quot;</span>
    <span style="color: #408080; font-style: italic"># Scaled pressure function</span>
    p <span style="color: #666666">=</span> Expression(
        <span style="color: #BA2121">&#39;4*exp(-pow(beta,2)*(pow(x[0], 2) + pow(x[1]-R0, 2)))&#39;</span>,
        beta<span style="color: #666666">=</span>beta, R0<span style="color: #666666">=</span>R0)

    <span style="color: #408080; font-style: italic"># Generate mesh over the unit circle</span>
    domain <span style="color: #666666">=</span> Circle(Point(<span style="color: #666666">0.0</span>, <span style="color: #666666">0.0</span>), <span style="color: #666666">1.0</span>)
    mesh <span style="color: #666666">=</span> generate_mesh(domain, num_elements_radial_dir)

    w <span style="color: #666666">=</span> solver(p, Constant(<span style="color: #666666">0</span>), mesh, degree<span style="color: #666666">=1</span>,
               linear_solver<span style="color: #666666">=</span><span style="color: #BA2121">&#39;direct&#39;</span>)
    w<span style="color: #666666">.</span>rename(<span style="color: #BA2121">&#39;w&#39;</span>, <span style="color: #BA2121">&#39;deflection&#39;</span>)

    <span style="color: #408080; font-style: italic"># Plot scaled solution, mesh and pressure</span>
    plot(mesh, title<span style="color: #666666">=</span><span style="color: #BA2121">&#39;Mesh over scaled domain&#39;</span>)
    viz_w <span style="color: #666666">=</span> plot(w,
                 wireframe<span style="color: #666666">=</span><span style="color: #008000">False</span>,
                 title<span style="color: #666666">=</span><span style="color: #BA2121">&#39;Scaled membrane deflection&#39;</span>,
                 axes<span style="color: #666666">=</span><span style="color: #008000">False</span>,
                 interactive<span style="color: #666666">=</span><span style="color: #008000">False</span>,
                 )
    viz_w<span style="color: #666666">.</span>elevate(<span style="color: #666666">-10</span>) <span style="color: #408080; font-style: italic"># adjust (lift) camera from default view</span>
    viz_w<span style="color: #666666">.</span>plot(w)      <span style="color: #408080; font-style: italic"># bring new settings into action</span>
    viz_w<span style="color: #666666">.</span>write_png(<span style="color: #BA2121">&#39;deflection&#39;</span>)
    viz_w<span style="color: #666666">.</span>write_pdf(<span style="color: #BA2121">&#39;deflection&#39;</span>)

    V <span style="color: #666666">=</span> w<span style="color: #666666">.</span>function_space()
    p <span style="color: #666666">=</span> interpolate(p, V)
    p<span style="color: #666666">.</span>rename(<span style="color: #BA2121">&#39;p&#39;</span>, <span style="color: #BA2121">&#39;pressure&#39;</span>)
    viz_p <span style="color: #666666">=</span> plot(p, title<span style="color: #666666">=</span><span style="color: #BA2121">&#39;Scaled pressure&#39;</span>, interactive<span style="color: #666666">=</span><span style="color: #008000">False</span>)
    viz_p<span style="color: #666666">.</span>elevate(<span style="color: #666666">-10</span>)
    viz_p<span style="color: #666666">.</span>plot(p)
    viz_p<span style="color: #666666">.</span>write_png(<span style="color: #BA2121">&#39;pressure&#39;</span>)
    viz_p<span style="color: #666666">.</span>write_pdf(<span style="color: #BA2121">&#39;pressure&#39;</span>)

    <span style="color: #408080; font-style: italic"># Dump w and p to file in VTK format</span>
    vtkfile1 <span style="color: #666666">=</span> File(<span style="color: #BA2121">&#39;membrane_deflection.pvd&#39;</span>)
    vtkfile1 <span style="color: #666666">&lt;&lt;</span> w
    vtkfile2 <span style="color: #666666">=</span> File(<span style="color: #BA2121">&#39;membrane_load.pvd&#39;</span>)
    vtkfile2 <span style="color: #666666">&lt;&lt;</span> p
</pre></div>
<p>
The striking feature is that the solver does not reproduce the solution
to an accuracy more than about 0.01 (!), regardless of the resolution and
type of element.

<p>
</div></p>
</div>
</p>

<p>
<!-- --- end solution of exercise --- -->

<p>
<!-- --- end exercise --- -->

<p>
<p>
<!-- navigation buttons at the bottom of the page -->
<ul class="pagination">
<li><a href="._ftut1010.html">&laquo;</a></li>
  <li><a href="._ftut1000.html">1</a></li>
  <li><a href="">...</a></li>
  <li><a href="._ftut1003.html">4</a></li>
  <li><a href="._ftut1004.html">5</a></li>
  <li><a href="._ftut1005.html">6</a></li>
  <li><a href="._ftut1006.html">7</a></li>
  <li><a href="._ftut1007.html">8</a></li>
  <li><a href="._ftut1008.html">9</a></li>
  <li><a href="._ftut1009.html">10</a></li>
  <li><a href="._ftut1010.html">11</a></li>
  <li class="active"><a href="._ftut1011.html">12</a></li>
  <li><a href="._ftut1012.html">13</a></li>
  <li><a href="._ftut1013.html">14</a></li>
  <li><a href="._ftut1014.html">15</a></li>
  <li><a href="._ftut1015.html">16</a></li>
  <li><a href="._ftut1012.html">&raquo;</a></li>
</ul>
<!-- ------------------- end of main content --------------- -->

</div>  <!-- end container -->
<!-- include javascript, jQuery *first* -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="http://netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>

<!-- Bootstrap footer
<footer>
<a href="http://..."><img width="250" align=right src="http://..."></a>
</footer>
-->


<center style="font-size:80%">
<!-- copyright only on the titlepage -->
</center>


</body>
</html>
    

